name: Debug Build Issue

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/debug-build.yml' ]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  debug-build:
    name: Debug Build Process
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Debug - Show environment
        run: |
          echo "ğŸ” Environment Debug Information"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Working directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo ""
          echo "ğŸ” Looking for package.json files:"
          find . -name "package.json" -not -path "*/node_modules/*" | head -10

      - name: Debug - Test frontend detection
        run: |
          echo "ğŸ” Testing frontend detection logic..."
          
          FE_DIR=""
          for pkg in $(find . -name "package.json" -not -path "*/node_modules/*"); do
            echo "Checking: $pkg"
            if grep -q '"build"' "$pkg"; then
              echo "  âœ… Has build script"
              if ! grep -q '"@pulumi/' "$pkg"; then
                echo "  âœ… Not Pulumi package"
                FE_DIR=$(dirname "$pkg")
                echo "  ğŸ¯ Selected as frontend: $FE_DIR"
                break
              else
                echo "  âŒ Is Pulumi package, skipping"
              fi
            else
              echo "  âŒ No build script"
            fi
          done
          
          if [ -z "$FE_DIR" ]; then
            FE_DIR="./apps/dashboard"
            echo "ğŸ”„ Fallback to default: $FE_DIR"
          fi
          
          echo "ğŸ“‹ Final frontend directory: $FE_DIR"
          
          if [ -d "$FE_DIR" ]; then
            echo "âœ… Directory exists"
            echo "ğŸ“‹ Contents:"
            ls -la "$FE_DIR"
            
            if [ -f "$FE_DIR/package.json" ]; then
              echo "âœ… package.json exists"
              echo "ğŸ“‹ Build script:"
              grep -A 3 -B 3 '"build"' "$FE_DIR/package.json" || echo "âŒ No build script found"
            else
              echo "âŒ No package.json in directory"
            fi
          else
            echo "âŒ Directory does not exist"
          fi

      - name: Debug - Test dependency installation
        run: |
          echo "ğŸ” Testing dependency installation..."
          
          FE_DIR="./apps/dashboard"
          
          if [ -d "$FE_DIR" ]; then
            cd "$FE_DIR"
            echo "ğŸ“‹ Current directory: $(pwd)"
            
            echo "ğŸ” Checking for lockfile:"
            if [ -f "package-lock.json" ]; then
              echo "âœ… package-lock.json exists"
              echo "ğŸ”§ Running: npm ci --legacy-peer-deps"
              npm ci --legacy-peer-deps
            else
              echo "âŒ No package-lock.json, using npm install"
              echo "ğŸ”§ Running: npm install --legacy-peer-deps"
              npm install --legacy-peer-deps
            fi
            
            INSTALL_EXIT_CODE=$?
            echo "ğŸ“Š Install exit code: $INSTALL_EXIT_CODE"
            
            if [ $INSTALL_EXIT_CODE -eq 0 ]; then
              echo "âœ… Dependencies installed successfully"
              
              echo "ğŸ” Checking node_modules:"
              if [ -d "node_modules" ]; then
                echo "âœ… node_modules directory exists"
                echo "ğŸ“Š Size: $(du -sh node_modules)"
              else
                echo "âŒ node_modules directory missing"
              fi
            else
              echo "âŒ Dependency installation failed"
              exit 1
            fi
          else
            echo "âŒ Frontend directory not found: $FE_DIR"
            exit 1
          fi

      - name: Debug - Test build process
        run: |
          echo "ğŸ” Testing build process..."
          
          FE_DIR="./apps/dashboard"
          
          if [ -d "$FE_DIR" ]; then
            cd "$FE_DIR"
            echo "ğŸ“‹ Current directory: $(pwd)"
            
            echo "ğŸ” Setting environment variables:"
            export VITE_API_URL="https://api.sophia-intel.ai"
            export NODE_ENV="production"
            
            echo "  VITE_API_URL: $VITE_API_URL"
            echo "  NODE_ENV: $NODE_ENV"
            
            echo "ğŸ”§ Running: npm run build"
            npm run build
            
            BUILD_EXIT_CODE=$?
            echo "ğŸ“Š Build exit code: $BUILD_EXIT_CODE"
            
            if [ $BUILD_EXIT_CODE -eq 0 ]; then
              echo "âœ… Build completed successfully"
              
              echo "ğŸ” Checking build output:"
              if [ -d "dist" ]; then
                echo "âœ… dist directory exists"
                echo "ğŸ“‹ Contents:"
                ls -la dist/
                echo "ğŸ“Š Size: $(du -sh dist/)"
              else
                echo "âŒ dist directory missing"
              fi
            else
              echo "âŒ Build failed"
              exit 1
            fi
          else
            echo "âŒ Frontend directory not found: $FE_DIR"
            exit 1
          fi

      - name: Debug - Summary
        if: always()
        run: |
          echo "ğŸ¯ Debug Summary"
          echo "==============="
          echo "This debug workflow tests each step of the build process individually"
          echo "to identify exactly where the failure occurs in the main workflow."
          echo ""
          echo "If this debug workflow passes, the issue is likely in the main workflow configuration."
          echo "If this debug workflow fails, we can see exactly which step is problematic."

