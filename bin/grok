#!/usr/bin/env bash
# Standalone Grok runner that sources repo-local .env.master only (no prompts, no fallbacks)
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")"/.. && pwd)"
ENV_FILE="$ROOT_DIR/.env.master"

# Parse .env.master minimally (key=value, ignore comments/blank)
if [[ -f "$ENV_FILE" ]]; then
  while IFS= read -r line; do
    [[ -z "$line" || "$line" =~ ^# ]] && continue
    if [[ "$line" == *=* ]]; then
      key="${line%%=*}"
      val="${line#*=}"
      key="${key//[$'\t\r\n ']}"
      val="${val%$'\r'}"
      val="${val%$'\n'}"
      val="${val%\'}"; val="${val#\'}"; val="${val%\"}"; val="${val#\"}"
      case "$key" in
        GROK_API_KEY)
          GROK_API_KEY_VALUE="$val";;
        XAI_API_KEY)
          XAI_API_KEY_VALUE="$val";;
      esac
    fi
  done < "$ENV_FILE"
fi

# Prefer explicit env, then GROK_API_KEY from file, then XAI_API_KEY from file
: "${GROK_API_KEY_VALUE:=}"
: "${XAI_API_KEY_VALUE:=}"

if [[ -z "${GROK_API_KEY:-}" ]]; then
  if [[ -n "$GROK_API_KEY_VALUE" ]]; then
    export GROK_API_KEY="$GROK_API_KEY_VALUE"
  elif [[ -n "$XAI_API_KEY_VALUE" ]]; then
    export GROK_API_KEY="$XAI_API_KEY_VALUE"
  fi
fi

exec grok "$@"
