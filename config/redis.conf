# Redis Configuration for Sophia Intel AI Platform
# Optimized for AI workloads, caching, and message streaming
# Based on Redis 7.2.x with performance and security enhancements

################################## NETWORK #####################################

# Bind to localhost only for security (can be overridden for containerized environments)
bind 127.0.0.1

# Standard Redis port
port 6379

# Disable protected mode since we're binding to localhost only
protected-mode yes

# TCP listen backlog
tcp-backlog 511

# TCP keepalive - helps detect dead connections
tcp-keepalive 300

# Client timeout (0 = disabled)
timeout 0

################################## GENERAL #####################################

# Run as daemon
daemonize no

# Set server verbosity to 'notice' for production
loglevel notice

# Log file (empty string = stdout)
logfile ""

# Number of databases
databases 16

# Always show logo
always-show-logo no

# Set server title for process management
set-proc-title yes
proc-title-template "{title} {listen-addr} {server-mode}"

################################## MEMORY MANAGEMENT ###########################

# Maximum memory limit (2GB optimized for Sophia Intel AI workloads)
maxmemory 2gb

# Memory policy when limit is reached - optimized for AI caching patterns
maxmemory-policy volatile-lru

# Sample size for LRU eviction (higher = more precise but slower)
maxmemory-samples 10

# Enable active memory defragmentation for long-running processes
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

################################## PERSISTENCE ################################

# Enable RDB snapshots for data persistence
save 3600 1      # Save if at least 1 key changed in 3600 seconds
save 300 100     # Save if at least 100 keys changed in 300 seconds  
save 60 10000    # Save if at least 10000 keys changed in 60 seconds

# Stop writes on RDB save error
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# Checksum RDB files
rdbchecksum yes

# RDB filename
dbfilename sophia-intel-ai.rdb

# Working directory
dir /opt/homebrew/var/db/redis

# Incremental fsync for RDB saves
rdb-save-incremental-fsync yes

# AOF (Append Only File) configuration - disabled by default for performance
appendonly no
appendfilename "sophia-intel-ai.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

################################## PERFORMANCE ################################

# Optimize for AI workload patterns
hz 10

# Enable lazy freeing for performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
lazyfree-lazy-user-del yes

# I/O threads for better performance on multi-core systems
io-threads 4
io-threads-do-reads yes

# Disable THP (Transparent Huge Pages) for better memory management
disable-thp yes

################################## DATA STRUCTURES ############################

# Hash optimization for AI metadata
hash-max-listpack-entries 512
hash-max-listpack-value 64

# List optimization for message queues
list-max-listpack-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512
set-max-listpack-entries 128
set-max-listpack-value 64

# ZSet optimization for scoring/ranking
zset-max-listpack-entries 128
zset-max-listpack-value 64

# Stream optimization for AI agent communication
stream-node-max-bytes 4096
stream-node-max-entries 100

################################## CLIENTS ####################################

# Maximum concurrent clients
maxclients 10000

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client query buffer limit
client-query-buffer-limit 1gb

################################## SLOW LOG ####################################

# Log queries slower than 10ms (10000 microseconds)
slowlog-log-slower-than 10000

# Keep last 128 slow queries in memory
slowlog-max-len 128

################################## LATENCY MONITORING ##########################

# Enable latency monitoring
latency-monitor-threshold 100

# Latency tracking
latency-tracking yes
latency-tracking-info-percentiles 50 99 99.9

################################## KEYSPACE NOTIFICATIONS #####################

# Enable keyspace notifications for cache invalidation and AI agent coordination
notify-keyspace-events "Ex"

################################## SECURITY ####################################

# Require authentication (should be set via environment variable)
# requirepass your-strong-password-here

# Rename dangerous commands for production security
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command EVAL ""
# rename-command CONFIG "CONFIG_87ea2c4a3b2"

# Enable ACLs (Access Control Lists) for fine-grained permissions
# aclfile /opt/redis/users.acl

################################## SOPHIA INTEL AI SPECIFIC ###################

# Optimizations for Pay Ready business cycles
# - Higher memory allocation during month-end
# - Extended persistence during critical periods
# - Performance monitoring for AI workloads

# Custom configuration flags for application awareness
# These are read by the application layer, not Redis itself

# // AI_WORKLOAD_OPTIMIZED: true
# // PAY_READY_MONTH_END_SCALING: true  
# // CACHE_HIT_RATIO_TARGET: 0.85
# // MEMORY_WARNING_THRESHOLD: 0.8
# // MEMORY_CRITICAL_THRESHOLD: 0.9

################################## REPLICATION ################################

# Replication settings (for future scaling)
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync yes
# repl-diskless-sync-delay 5

################################## CLUSTERING #################################

# Clustering disabled for single-instance deployment
# cluster-enabled no

################################## MODULES ####################################

# Load Redis modules for AI workloads (when available)
# loadmodule /opt/redis-modules/redisai.so
# loadmodule /opt/redis-modules/redisgears.so
# loadmodule /opt/redis-modules/redistimeseries.so

################################## DEBUGGING ##################################

# Debugging features (disable in production)
# enable-debug-command no
# enable-module-command no

# Crash handling
crash-log-enabled yes
crash-memcheck-enabled yes

################################## END ########################################

# Configuration validation
# This configuration is optimized for:
# - AI agent coordination and communication
# - High-frequency caching with LRU eviction
# - Streaming data for real-time processing
# - Pay Ready business cycle spikes
# - Memory efficiency and performance
# - Security best practices