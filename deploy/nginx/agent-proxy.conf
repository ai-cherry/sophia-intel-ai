events { worker_connections 1024; }

http {
  upstream ui { server agent-ui:3000; }
  upstream api { server sophia-api:8003; }

  server {
    listen 80;

    # Simple health endpoint for proxy
    location /health { access_log off; return 200 "Proxy OK\n"; add_header Content-Type text/plain; }

    # Default: serve UI
    location / {
      proxy_pass http://ui;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
    }

    # REST API under /api/*
    location /api/ {
      rewrite ^/api/?(.*)$ /$1 break;
      proxy_pass http://api;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
    }

    # WebSockets under /ws/*
    location /ws/ {
      proxy_pass http://api;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_read_timeout 3600s;
    }
  }
}

