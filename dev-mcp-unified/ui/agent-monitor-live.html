<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Factory - Live Monitoring</title>
    <link rel="stylesheet" href="./artemis-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .monitor-layout {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 16px;
            padding: 16px;
        }

        .header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 0 24px;
            border: 2px solid var(--border-light);
        }

        .header h1 {
            margin: 0;
            color: var(--text-accent);
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .agents-panel {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 12px;
            border: 2px solid var(--border-light);
            padding: 20px;
        }

        .agents-panel h3 {
            margin: 0 0 16px 0;
            color: var(--text-accent);
            font-size: 16px;
            font-weight: 600;
        }

        .agent-card {
            background: var(--bg-primary);
            border: 2px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .agent-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .agent-card.active {
            border-color: var(--accent-blue);
            background: linear-gradient(135deg, var(--bg-primary), var(--accent-blue-light));
        }

        .agent-card.running {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, var(--bg-primary), rgba(34, 197, 94, 0.05));
        }

        .agent-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .agent-role {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.idle { background: var(--text-muted); }
        .status-dot.thinking { background: var(--accent-yellow); animation: pulse 1s infinite; }
        .status-dot.working { background: var(--accent-blue); animation: pulse 1s infinite; }
        .status-dot.completed { background: var(--accent-green); }
        .status-dot.error { background: var(--accent-red); }

        .main-monitor {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 12px;
            border: 2px solid var(--border-light);
            display: flex;
            flex-direction: column;
        }

        .monitor-tabs {
            display: flex;
            background: var(--bg-quaternary);
            border-radius: 10px 10px 0 0;
            border-bottom: 2px solid var(--border-light);
        }

        .monitor-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: all var(--transition-fast);
            background: transparent;
            border: none;
            color: var(--text-muted);
        }

        .monitor-tab.active {
            color: var(--accent-blue);
            background: var(--bg-primary);
            border-bottom: 2px solid var(--accent-blue);
        }

        .monitor-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
        }

        .chat-message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            animation: slideInMessage 0.3s ease-out;
        }

        .chat-message.agent {
            background: linear-gradient(135deg, var(--bg-primary), rgba(59, 130, 246, 0.05));
            border-left: 3px solid var(--accent-blue);
        }

        .chat-message.system {
            background: linear-gradient(135deg, var(--bg-primary), rgba(251, 191, 36, 0.05));
            border-left: 3px solid var(--accent-yellow);
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-sender {
            font-weight: 600;
            color: var(--text-accent);
        }

        .message-timestamp {
            font-size: 11px;
            color: var(--text-muted);
        }

        .message-text {
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .thinking-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--accent-blue);
            font-style: italic;
        }

        .thinking-dots {
            display: inline-flex;
            gap: 2px;
        }

        .thinking-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--accent-blue);
            animation: thinking 1.4s infinite ease-in-out both;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes thinking {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .controls-panel {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 12px;
            border: 2px solid var(--border-light);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .controls-section h4 {
            margin: 0 0 12px 0;
            color: var(--text-accent);
            font-size: 14px;
            font-weight: 600;
        }

        .control-button {
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-button:hover {
            background: var(--accent-blue-hover);
            transform: translateY(-1px);
        }

        .control-button.danger {
            background: var(--accent-red);
        }

        .control-button.danger:hover {
            background: var(--accent-red-hover);
        }

        .control-button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .execution-progress {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border-light);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-blue-light));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .file-changes {
            max-height: 200px;
            overflow-y: auto;
        }

        .file-change {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 4px;
            border-left: 3px solid var(--accent-blue);
        }

        .file-change.modified { border-left-color: var(--accent-yellow); }
        .file-change.added { border-left-color: var(--accent-green); }
        .file-change.deleted { border-left-color: var(--accent-red); }

        .file-icon {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
        }

        .approval-request {
            background: linear-gradient(135deg, var(--bg-primary), rgba(251, 191, 36, 0.1));
            border: 2px solid var(--accent-yellow);
            border-radius: 10px;
            padding: 16px;
            margin: 12px 0;
        }

        .approval-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: var(--accent-yellow);
            font-weight: 600;
        }

        .approval-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .approve-btn {
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 500;
        }

        .reject-btn {
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 500;
        }

        @keyframes slideInMessage {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="monitor-layout">
        <div class="header">
            <h1>
                üî¨ Agent Factory - Live Monitoring
                <div class="status-indicator"></div>
            </h1>
            <div style="display: flex; gap: 16px; align-items: center;">
                <span style="font-size: 12px; color: var(--text-muted);">Server: http://127.0.0.1:3333</span>
                <span id="connection-status" style="font-size: 12px; color: var(--accent-green);">‚óè Connected</span>
            </div>
        </div>

        <div class="agents-panel">
            <h3>ü§ñ Active Agents</h3>
            <div id="agents-list">
                <!-- Agents will be populated here -->
            </div>
            
            <div style="margin-top: 20px;">
                <h4 style="margin: 0 0 8px 0; font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Quick Deploy</h4>
                <select id="template-select" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-light); background: var(--bg-primary); color: var(--text-primary);">
                    <option value="">Select Template...</option>
                    <option value="coding">Coding Swarm</option>
                    <option value="debug">Debug Squad</option>
                    <option value="review">Code Review Team</option>
                </select>
                <button onclick="deployTemplate()" style="width: 100%; margin-top: 8px;" class="control-button">
                    üöÄ Deploy Swarm
                </button>
            </div>
        </div>

        <div class="main-monitor">
            <div class="monitor-tabs">
                <button class="monitor-tab active" onclick="switchTab('chat')">üí¨ Execution Chat</button>
                <button class="monitor-tab" onclick="switchTab('files')">üìÅ File Changes</button>
                <button class="monitor-tab" onclick="switchTab('logs')">üìä System Logs</button>
            </div>
            
            <div class="monitor-content">
                <div id="chat-tab" class="chat-feed">
                    <div class="chat-message system">
                        <div class="message-avatar">üõ†Ô∏è</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">System</span>
                                <span class="message-timestamp">10:45:23</span>
                            </div>
                            <div class="message-text">Agent Factory monitoring system initialized. Ready for agent deployment.</div>
                        </div>
                    </div>
                </div>
                
                <div id="files-tab" class="file-changes" style="display: none;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">No file changes detected yet</p>
                </div>
                
                <div id="logs-tab" style="display: none;">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">System logs will appear here</p>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="controls-section">
                <h4>üéÆ Execution Control</h4>
                <button id="pause-btn" class="control-button" onclick="pauseExecution()">
                    ‚è∏Ô∏è Pause Agents
                </button>
                <button id="resume-btn" class="control-button" onclick="resumeExecution()" disabled>
                    ‚ñ∂Ô∏è Resume Agents
                </button>
                <button class="control-button danger" onclick="stopAllAgents()">
                    ‚èπÔ∏è Stop All
                </button>
            </div>

            <div class="controls-section">
                <h4>üìà Current Execution</h4>
                <div class="execution-progress">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">
                        <span id="current-step">Waiting for deployment...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h4>üìÇ File Operations</h4>
                <div style="display: flex; gap: 8px;">
                    <button class="control-button" style="flex: 1; font-size: 12px;" onclick="reviewChanges()">
                        üìã Review
                    </button>
                    <button class="control-button" style="flex: 1; font-size: 12px;" onclick="commitChanges()">
                        üíæ Commit
                    </button>
                </div>
            </div>

            <div class="controls-section">
                <h4>‚öôÔ∏è Settings</h4>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                    <input type="checkbox" id="auto-approve" style="accent-color: var(--accent-blue);">
                    Auto-approve safe changes
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; margin-top: 4px;">
                    <input type="checkbox" id="show-thinking" checked style="accent-color: var(--accent-blue);">
                    Show agent reasoning
                </label>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'http://127.0.0.1:3333';
        let currentTab = 'chat';
        let activeAgents = [];
        let executionPaused = false;

        // Initialize monitoring system
        async function initMonitoring() {
            try {
                // Load active agents
                await loadActiveAgents();
                
                // Connect to real-time updates (if available)
                connectToLiveUpdates();
                
                console.log('Agent Factory monitoring initialized');
            } catch (error) {
                console.error('Failed to initialize monitoring:', error);
                updateConnectionStatus(false);
            }
        }

        async function loadActiveAgents() {
            try {
                const response = await fetch(`${SERVER_URL}/api/factory/swarms`);
                const swarms = await response.json();
                
                activeAgents = [];
                swarms.forEach(swarm => {
                    swarm.agents?.forEach(agent => {
                        activeAgents.push({
                            id: agent.name.toLowerCase().replace(/\s+/g, '_'),
                            name: agent.name,
                            role: agent.role,
                            status: 'idle',
                            swarmId: swarm.id
                        });
                    });
                });
                
                renderAgentsList();
            } catch (error) {
                console.error('Failed to load agents:', error);
            }
        }

        function renderAgentsList() {
            const agentsList = document.getElementById('agents-list');
            agentsList.innerHTML = '';

            activeAgents.forEach(agent => {
                const agentCard = document.createElement('div');
                agentCard.className = `agent-card ${agent.status}`;
                agentCard.onclick = () => selectAgent(agent.id);
                
                agentCard.innerHTML = `
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-role">${agent.role}</div>
                    <div class="agent-status">
                        <div class="status-dot ${agent.status}"></div>
                        <span>${agent.status}</span>
                    </div>
                `;
                
                agentsList.appendChild(agentCard);
            });
        }

        function selectAgent(agentId) {
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('active');
            });
            
            const selectedCard = document.querySelector(`.agent-card:nth-child(${activeAgents.findIndex(a => a.id === agentId) + 1})`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }
            
            // Filter chat messages for selected agent
            filterChatForAgent(agentId);
        }

        function connectToLiveUpdates() {
            // Simulate live updates for demo
            setInterval(() => {
                if (!executionPaused && activeAgents.length > 0) {
                    simulateAgentActivity();
                }
            }, 3000);
        }

        function simulateAgentActivity() {
            const randomAgent = activeAgents[Math.floor(Math.random() * activeAgents.length)];
            const activities = [
                'Analyzing code structure...',
                'Generating implementation plan...',
                'Reviewing security implications...',
                'Optimizing performance patterns...',
                'Running quality checks...'
            ];
            
            const activity = activities[Math.floor(Math.random() * activities.length)];
            addChatMessage(randomAgent.name, activity, 'agent');
            
            // Update agent status
            randomAgent.status = 'working';
            renderAgentsList();
            
            // Reset status after work
            setTimeout(() => {
                randomAgent.status = 'idle';
                renderAgentsList();
            }, 2000);
        }

        function addChatMessage(sender, text, type = 'agent') {
            const chatFeed = document.getElementById('chat-tab');
            const message = document.createElement('div');
            message.className = `chat-message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const avatar = type === 'agent' ? sender.charAt(0).toUpperCase() : 'ü§ñ';
            
            message.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${sender}</span>
                        <span class="message-timestamp">${timestamp}</span>
                    </div>
                    <div class="message-text">${text}</div>
                </div>
            `;
            
            chatFeed.appendChild(message);
            chatFeed.scrollTop = chatFeed.scrollHeight;
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.monitor-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Show/hide tab content
            document.querySelectorAll('#chat-tab, #files-tab, #logs-tab').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${tabName}-tab`).style.display = 'flex';
        }

        function pauseExecution() {
            executionPaused = true;
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('resume-btn').disabled = false;
            addChatMessage('System', '‚è∏Ô∏è Execution paused by user', 'system');
        }

        function resumeExecution() {
            executionPaused = false;
            document.getElementById('pause-btn').disabled = false;
            document.getElementById('resume-btn').disabled = true;
            addChatMessage('System', '‚ñ∂Ô∏è Execution resumed', 'system');
        }

        function stopAllAgents() {
            activeAgents.forEach(agent => {
                agent.status = 'idle';
            });
            renderAgentsList();
            addChatMessage('System', 'üõë All agents stopped', 'system');
            updateProgress(0, 'Stopped by user');
        }

        function deployTemplate() {
            const template = document.getElementById('template-select').value;
            if (!template) return;
            
            addChatMessage('System', `üöÄ Deploying ${template} template...`, 'system');
            updateProgress(10, 'Initializing agents...');
            
            // Simulate deployment progress
            setTimeout(() => updateProgress(50, 'Loading agent personas...'), 1000);
            setTimeout(() => updateProgress(75, 'Establishing connections...'), 2000);
            setTimeout(() => updateProgress(100, 'Ready for execution'), 3000);
        }

        function updateProgress(percent, step) {
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-percent').textContent = percent + '%';
            document.getElementById('current-step').textContent = step;
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            if (connected) {
                status.textContent = '‚óè Connected';
                status.style.color = 'var(--accent-green)';
            } else {
                status.textContent = '‚óè Disconnected';
                status.style.color = 'var(--accent-red)';
            }
        }

        function reviewChanges() {
            switchTab('files');
            addChatMessage('System', 'üìã Opening file changes for review...', 'system');
        }

        function commitChanges() {
            addChatMessage('System', 'üíæ Committing changes to repository...', 'system');
        }

        function filterChatForAgent(agentId) {
            // Implementation for filtering chat messages by agent
            console.log('Filtering chat for agent:', agentId);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initMonitoring);
    </script>
</body>
</html>