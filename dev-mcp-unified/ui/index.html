<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sophia & Artemis</title>
  <link rel="stylesheet" href="./artemis-styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Tab-specific overrides using the unified design system */
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    
    .tabs {
      display: flex;
      gap: 2px;
      border-bottom: 2px solid var(--border-light);
      padding: 0;
      background: var(--bg-secondary);
    }
    
    .tab {
      padding: 14px 20px;
      border: none;
      border-radius: 0;
      background: var(--bg-tertiary);
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all var(--transition-fast);
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: transparent;
      transition: background var(--transition-fast);
    }
    
    .tab:hover {
      background: var(--bg-quaternary);
      color: var(--text-primary);
    }
    
    .tab.active {
      background: var(--bg-primary);
      color: var(--text-accent);
    }
    
    .tab.active::after {
      background: var(--accent-blue);
    }
    
    .tab-icon {
      font-size: 16px;
    }
    
    .view {
      height: calc(100vh - 56px);
      overflow: hidden;
    }
    
    iframe {
      width: 100%;
      height: 100%;
      border: 0;
    }
    
    /* Sophia business dashboard styles */
    .sophia-dashboard {
      height: 100%;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" id="tab-artemis" onclick="show('artemis')" role="tab" aria-selected="true" aria-controls="frame-artemis">
      <span class="tab-icon">🎯</span>
      Artemis (Coding)
    </div>
    <div class="tab" id="tab-sophia" onclick="show('sophia')" role="tab" aria-selected="false" aria-controls="frame-sophia">
      <span class="tab-icon">📊</span>
      Sophia (Business)
    </div>
    <div class="tab" id="tab-code" onclick="window.open('./code-manager.html', '_blank')" role="button" aria-label="Open Code Manager in new tab">
      <span class="tab-icon">⚡</span>
      Code Manager ↗
    </div>
  </div>
  <div class="view">
    <iframe id="frame-artemis" src="./artemis-enhanced.html" title="Artemis Multi-Model Chat Interface"></iframe>
    <div id="frame-sophia" class="sophia-dashboard" style="display:none" role="tabpanel" aria-labelledby="tab-sophia">
      
      <!-- Business Dashboard Header -->
      <div class="business-header">
        <div class="business-title">
          <span>📊</span>
          Business Intelligence Dashboard
        </div>
        <div class="business-subtitle">
          AI-powered insights for sales signals, leads, and customer interactions
        </div>
        
        <!-- Model Selection for Business Insights -->
        <div class="business-model-selector">
          <label for="business-model-select">AI Model:</label>
          <select id="business-model-select" class="business-model-dropdown" onchange="onBusinessModelChange()">
            <option value="openai/gpt-4">GPT-4 (OpenAI)</option>
            <option value="anthropic/claude-3-sonnet">Claude 3 Sonnet</option>
            <option value="meta-llama/llama-3.2-3b-instruct">Llama 3.2 3B</option>
            <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
          </select>
          <button class="business-btn" onclick="generateInsights()" id="insights-btn">
            <span>🔍</span>
            Generate AI Insights
          </button>
        </div>
        
        <!-- Business Controls -->
        <div class="business-controls">
          <button class="business-btn" onclick="loadSignals()" id="signals-btn">
            <span>📡</span>
            Load Signals
          </button>
          <button class="business-btn" onclick="loadLeads()" id="leads-btn">
            <span>🎯</span>
            Load Leads
          </button>
          <button class="business-btn" onclick="loadGong()" id="gong-btn">
            <span>📞</span>
            Gong Calls (7d)
          </button>
          <span id="biz-status" class="business-status">Ready</span>
        </div>
      </div>
      
      <!-- Business Content Grid -->
      <div id="biz-content" class="business-grid">
        <div class="empty-state">
          <div class="empty-state-icon">📊</div>
          <div class="empty-state-title">No Data Loaded</div>
          <div class="empty-state-description">
            Select a data source above to begin analyzing your business intelligence
          </div>
        </div>
      </div>
      <!-- Enhanced Preview Modal -->
      <div id="preview-modal" class="preview-modal">
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">Message Preview</div>
            <button class="modal-close" onclick="closePreview()" aria-label="Close preview">×</button>
          </div>
          <div class="modal-body">
            <div id="preview-body" class="modal-preview-text"></div>
          </div>
        </div>
      </div>
      <script>
        // Global variables
        let selectedBusinessModel = 'openai/gpt-4';
        let currentBusinessData = null;
        
        // Enhanced loading functions with better UX
        async function loadSignals(){
          const btn = document.getElementById('signals-btn');
          const st = document.getElementById('biz-status');
          const content = document.getElementById('biz-content');
          
          setLoadingState(btn, st, 'Loading signals…');
          
          try{
            const r = await fetch('http://127.0.0.1:3333/business/signals');
            const data = await r.json();
            currentBusinessData = { type: 'signals', data };
            
            st.textContent = `Loaded ${data.count || 0} signals`;
            content.innerHTML = '';
            
            if (!data.items || data.items.length === 0) {
              content.appendChild(createEmptyState('📡', 'No Signals Found', 'No sales signals available at the moment.'));
            } else {
              data.items.forEach(s => content.appendChild(signalCard(s)));
            }
          } catch(e) { 
            st.textContent = 'Error loading signals';
            console.error('Signals error:', e);
            content.innerHTML = '';
            content.appendChild(createErrorState('Failed to load signals: ' + e.message));
          } finally {
            clearLoadingState(btn);
          }
        }
        
        function signalCard(s){
          const card = document.createElement('div');
          card.className = 'business-card signal';
          card.innerHTML = `
            <div class="card-header">
              <div>
                <div class="card-title">${s.person} • ${s.title}</div>
                <div class="card-subtitle">${s.company}</div>
              </div>
              <div class="card-strength">${(s.signalStrength*100).toFixed(0)}%</div>
            </div>
            <div class="card-content">
              <div class="card-meta">
                <div class="card-meta-item">
                  <span>🏷️</span>
                  <span>${s.signalType}</span>
                </div>
                <div class="card-meta-item">
                  <span>📅</span>
                  <span>${formatDate(s.updatedAt)}</span>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button class="card-btn primary" onclick="analyzeSignal('${s.person}', '${s.signalType}', '${s.company}')">
                🔍 Analyze
              </button>
              <button class="card-btn" onclick="viewSignalDetails('${s.signalId || s.person}')">
                👁️ Details
              </button>
            </div>
          `;
          return card;
        }
        async function loadLeads(){
          const btn = document.getElementById('leads-btn');
          const st = document.getElementById('biz-status');
          const content = document.getElementById('biz-content');
          
          setLoadingState(btn, st, 'Loading leads…');
          
          try{
            const r = await fetch('http://127.0.0.1:3333/business/leads');
            const data = await r.json();
            currentBusinessData = { type: 'leads', data };
            
            st.textContent = `Loaded ${data.count || 0} leads`;
            content.innerHTML = '';
            
            if (!data.items || data.items.length === 0) {
              content.appendChild(createEmptyState('🎯', 'No Leads Found', 'No qualified leads available at the moment.'));
            } else {
              data.items.forEach(ld => content.appendChild(leadCard(ld)));
            }
          } catch(e) { 
            st.textContent = 'Error loading leads';
            console.error('Leads error:', e);
            content.innerHTML = '';
            content.appendChild(createErrorState('Failed to load leads: ' + e.message));
          } finally {
            clearLoadingState(btn);
          }
        }
        
        function leadCard(ld){
          const card = document.createElement('div');
          card.className = 'business-card lead';
          const personaIcon = ld.personaMatch ? '✅' : '❌';
          const personaText = ld.personaMatch ? 'Match' : 'No Match';
          
          card.innerHTML = `
            <div class="card-header">
              <div>
                <div class="card-title">${ld.person} • ${ld.title}</div>
                <div class="card-subtitle">${ld.company}</div>
              </div>
              <div class="card-strength">${(ld.signalStrength*100).toFixed(0)}%</div>
            </div>
            <div class="card-content">
              <div class="card-meta">
                <div class="card-meta-item">
                  <span>🏷️</span>
                  <span>${ld.signalType}</span>
                </div>
                <div class="card-meta-item">
                  <span>👤</span>
                  <span>${ld.owner}</span>
                </div>
                <div class="card-meta-item">
                  <span>${personaIcon}</span>
                  <span>Persona ${personaText}</span>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button class="card-btn primary" onclick="previewMessage('${ld.leadId}','${ld.signalType}','${ld.person}','${ld.title}','${ld.company}')">
                📝 Preview Message
              </button>
              <button class="card-btn" onclick="analyzeSignal('${ld.person}', '${ld.signalType}', '${ld.company}')">
                🔍 Analyze
              </button>
            </div>
          `;
          return card;
        }
        async function previewMessage(leadId, signalType, person, title, company){
          const modal = document.getElementById('preview-modal');
          const previewBody = document.getElementById('preview-body');
          
          // Show modal with loading state
          previewBody.innerHTML = '<div class="loading-spinner"></div> Generating message preview...';
          modal.classList.add('show');
          
          try{
            const r = await fetch('http://127.0.0.1:3333/business/message/preview', {
              method: 'POST', 
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({leadId, signalType, persona: title, person, title, company})
            });
            const data = await r.json();
            previewBody.textContent = data.draft || JSON.stringify(data, null, 2);
          }catch(e){
            previewBody.textContent = 'Error generating message preview:\n\n' + e.message;
          }
        }
        
        function closePreview(){ 
          document.getElementById('preview-modal').classList.remove('show');
        }
        
        async function loadGong(){
          const btn = document.getElementById('gong-btn');
          const st = document.getElementById('biz-status');
          const content = document.getElementById('biz-content');
          
          setLoadingState(btn, st, 'Loading Gong calls…');
          
          try{
            const r = await fetch('http://127.0.0.1:3333/business/gong/recent?days=7');
            const data = await r.json();
            currentBusinessData = { type: 'gong', data };
            
            if (data.error) {
              st.textContent = 'Gong API error';
              content.innerHTML = '';
              content.appendChild(createErrorState('Gong API Error: ' + data.error));
            } else {
              st.textContent = `Loaded ${data.count || 0} calls`;
              content.innerHTML = '';
              
              if (!data.calls || data.calls.length === 0) {
                content.appendChild(createEmptyState('📞', 'No Calls Found', 'No recent Gong calls in the last 7 days.'));
              } else {
                data.calls.forEach(c => content.appendChild(gongCard(c)));
              }
            }
          } catch(e) { 
            st.textContent = 'Error loading Gong calls';
            console.error('Gong error:', e);
            content.innerHTML = '';
            content.appendChild(createErrorState('Failed to load Gong calls: ' + e.message));
          } finally {
            clearLoadingState(btn);
          }
        }
        
        function gongCard(call){
          const card = document.createElement('div');
          card.className = 'business-card gong';
          card.innerHTML = `
            <div class="card-header">
              <div>
                <div class="card-title">${call.topic || 'Untitled Call'}</div>
                <div class="card-subtitle">Gong Call Recording</div>
              </div>
            </div>
            <div class="card-content">
              <div class="card-meta">
                <div class="card-meta-item">
                  <span>📅</span>
                  <span>${formatDate(call.date)}</span>
                </div>
                <div class="card-meta-item">
                  <span>⏱️</span>
                  <span>${formatDuration(call.durationSec)}</span>
                </div>
                ${call.participants ? `
                <div class="card-meta-item">
                  <span>👥</span>
                  <span>${call.participants} participants</span>
                </div>
                ` : ''}
              </div>
            </div>
            <div class="card-actions">
              <button class="card-btn primary" onclick="analyzeCall('${call.id || 'unknown'}', '${call.topic || 'Call'}')">
                🔍 Analyze Call
              </button>
              <button class="card-btn" onclick="viewCallDetails('${call.id || 'unknown'}')">
                👁️ View Details
              </button>
            </div>
          `;
          return card;
        }
        
        // Utility functions for better UX
        function setLoadingState(button, status, message) {
          button.classList.add('loading');
          button.innerHTML = `<div class="loading-spinner"></div> ${button.textContent}`;
          status.textContent = message;
        }
        
        function clearLoadingState(button) {
          button.classList.remove('loading');
          // Restore original button content
          const buttonText = button.textContent.replace(/^.*\s/, '');
          const icon = button.querySelector('span') ? button.querySelector('span').outerHTML : '';
          button.innerHTML = icon + ' ' + buttonText;
        }
        
        function createEmptyState(icon, title, description) {
          const div = document.createElement('div');
          div.className = 'empty-state';
          div.innerHTML = `
            <div class="empty-state-icon">${icon}</div>
            <div class="empty-state-title">${title}</div>
            <div class="empty-state-description">${description}</div>
          `;
          return div;
        }
        
        function createErrorState(message) {
          const div = document.createElement('div');
          div.className = 'empty-state';
          div.innerHTML = `
            <div class="empty-state-icon">❌</div>
            <div class="empty-state-title">Error</div>
            <div class="empty-state-description">${message}</div>
          `;
          return div;
        }
        
        function formatDate(dateString) {
          if (!dateString) return 'Unknown';
          const date = new Date(dateString);
          return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function formatDuration(seconds) {
          if (!seconds) return '0s';
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
        }
        
        // Business model selection
        function onBusinessModelChange() {
          const select = document.getElementById('business-model-select');
          selectedBusinessModel = select.value;
          console.log('Selected business model:', selectedBusinessModel);
        }
        
        // AI-powered insights generation
        async function generateInsights() {
          if (!currentBusinessData) {
            alert('Please load some business data first (Signals, Leads, or Gong calls)');
            return;
          }
          
          const btn = document.getElementById('insights-btn');
          const status = document.getElementById('biz-status');
          
          setLoadingState(btn, status, 'Generating AI insights…');
          
          try {
            const response = await fetch('http://127.0.0.1:3333/proxy/openrouter', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                model: selectedBusinessModel,
                messages: [{
                  role: 'user',
                  content: `Analyze this business data and provide actionable insights:\n\nData Type: ${currentBusinessData.type}\nData: ${JSON.stringify(currentBusinessData.data, null, 2)}\n\nPlease provide:\n1. Key trends and patterns\n2. Priority actions\n3. Risk areas\n4. Opportunities`
                }]
              })
            });
            
            const data = await response.json();
            const insights = data.text || 'Unable to generate insights';
            
            // Show insights in modal
            const modal = document.getElementById('preview-modal');
            const modalTitle = modal.querySelector('.modal-title');
            const previewBody = document.getElementById('preview-body');
            
            modalTitle.textContent = `AI Insights - ${currentBusinessData.type.charAt(0).toUpperCase() + currentBusinessData.type.slice(1)}`;
            previewBody.textContent = insights;
            modal.classList.add('show');
            
            status.textContent = 'AI insights generated';
            
          } catch (error) {
            console.error('Insights generation error:', error);
            status.textContent = 'Error generating insights';
            alert('Failed to generate insights: ' + error.message);
          } finally {
            clearLoadingState(btn);
          }
        }
        
        // Additional action functions
        async function analyzeSignal(person, signalType, company) {
          console.log('Analyzing signal:', person, signalType, company);
          // Implement signal analysis
          alert(`Analyzing signal for ${person} at ${company} (${signalType})`);
        }
        
        async function viewSignalDetails(signalId) {
          console.log('Viewing signal details:', signalId);
          // Implement signal details view
          alert(`Viewing details for signal: ${signalId}`);
        }
        
        async function analyzeCall(callId, topic) {
          console.log('Analyzing call:', callId, topic);
          // Implement call analysis
          alert(`Analyzing call: ${topic}`);
        }
        
        async function viewCallDetails(callId) {
          console.log('Viewing call details:', callId);
          // Implement call details view
          alert(`Viewing details for call: ${callId}`);
        }
        
        // Load available models for business insights
        async function loadBusinessModels() {
          try {
            const resp = await fetch('http://127.0.0.1:3333/proxy/openrouter/models');
            const data = await resp.json();
            
            if (data.models && data.models.length > 0) {
              const select = document.getElementById('business-model-select');
              const businessModels = data.models.filter(m => 
                m.id.includes('gpt') || 
                m.id.includes('claude') || 
                m.id.includes('llama')
              ).slice(0, 10); // Limit to top 10 relevant models
              
              select.innerHTML = businessModels.map(m => 
                `<option value="${m.id}">${m.name || m.id}</option>`
              ).join('');
              
              selectedBusinessModel = businessModels[0]?.id || 'openai/gpt-4';
            }
          } catch (error) {
            console.error('Failed to load business models:', error);
          }
        }
        
        // Initialize business tab
        function initializeBusiness() {
          loadBusinessModels();
        }
        
        // Close modal on outside click
        document.addEventListener('click', (e) => {
          const modal = document.getElementById('preview-modal');
          if (e.target === modal) {
            closePreview();
          }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            closePreview();
          }
        });
      </script>
    </div>
  </div>
  <script>
    // Enhanced tab switching with accessibility support
    function show(which){
      // Update tab states
      const artemisTab = document.getElementById('tab-artemis');
      const sophiaTab = document.getElementById('tab-sophia');
      const artemisFrame = document.getElementById('frame-artemis');
      const sophiaFrame = document.getElementById('frame-sophia');
      
      // Reset all tabs
      artemisTab.classList.toggle('active', which === 'artemis');
      sophiaTab.classList.toggle('active', which === 'sophia');
      
      // Update ARIA attributes
      artemisTab.setAttribute('aria-selected', which === 'artemis');
      sophiaTab.setAttribute('aria-selected', which === 'sophia');
      
      // Show/hide content
      artemisFrame.style.display = (which === 'artemis') ? 'block' : 'none';
      sophiaFrame.style.display = (which === 'sophia') ? 'block' : 'none';
      
      // Initialize Sophia tab on first view
      if (which === 'sophia' && !sophiaFrame.dataset.initialized) {
        sophiaFrame.dataset.initialized = 'true';
        initializeBusiness();
      }
      
      // Update URL for deep-linking
      try { 
        history.replaceState(null, '', which === 'sophia' ? '#sophia' : '#artemis'); 
      } catch(e) {
        console.warn('Unable to update URL:', e);
      }
    }
    
    // Initialize from URL hash
    function initializeFromHash() {
      const hash = (location.hash || '').toLowerCase();
      if (hash === '#sophia') {
        show('sophia');
      } else {
        show('artemis');
      }
    }
    
    // Keyboard navigation for tabs
    document.addEventListener('keydown', (e) => {
      if (e.altKey && e.key >= '1' && e.key <= '2') {
        e.preventDefault();
        if (e.key === '1') show('artemis');
        if (e.key === '2') show('sophia');
      }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initializeFromHash);
    
    // Handle hash changes (back/forward button)
    window.addEventListener('hashchange', initializeFromHash);
    
    // Initialize immediately for browsers that don't fire DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeFromHash);
    } else {
      initializeFromHash();
    }
  </script>
</body>
</html>
