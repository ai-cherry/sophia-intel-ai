<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artemis Multiâ€‘Model Chat (6)</title>
  <link rel="stylesheet" href="./artemis-styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Enhanced styles using design system variables */
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    
    header {
      padding: 16px 20px;
      border-bottom: 2px solid var(--border-light);
      background: var(--bg-secondary);
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    header strong {
      color: var(--text-accent);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .send-all {
      flex: 1;
      display: flex;
      gap: 8px;
      min-width: 300px;
    }
    
    .send-all input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 8px;
      border: 2px solid var(--border-light);
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: all var(--transition-fast);
    }
    
    .send-all input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: var(--shadow-glow);
    }
    
    .send-all button {
      padding: 10px 16px;
      border-radius: 8px;
      border: 2px solid var(--accent-blue);
      background: var(--accent-blue);
      color: white;
      cursor: pointer;
      font-weight: 500;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .send-all button:hover {
      background: var(--accent-blue-hover);
      transform: translateY(-1px);
    }
    
    .grid {
      display: grid;
      gap: 16px;
      padding: 16px;
      grid-template-columns: repeat(3, 1fr);
    }
    
    /* Enhanced pane styles using design system */
    .pane {
      border: 2px solid var(--border-light);
      border-radius: 12px;
      background: linear-gradient(145deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      display: flex;
      flex-direction: column;
      min-height: 350px;
      transition: all var(--transition-medium);
      position: relative;
    }
    
    .pane:hover {
      border-color: var(--border-accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .pane header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 2px solid var(--border-light);
      background: var(--bg-quaternary);
    }
    
    .pane header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-accent);
    }
    
    .pane select {
      background: var(--bg-primary);
      border: 2px solid var(--border-light);
      border-radius: 6px;
      padding: 6px 8px;
      color: var(--text-primary);
      font-size: 12px;
      transition: all var(--transition-fast);
      max-width: 150px;
    }
    
    .pane select:focus {
      outline: none;
      border-color: var(--accent-blue);
    }
    
    .log {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scrollbar-width: thin;
      scrollbar-color: var(--border-light) transparent;
    }
    
    .log::-webkit-scrollbar {
      width: 6px;
    }
    
    .log::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .log::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }
    
    .msg {
      padding: 10px 12px;
      border-radius: 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      white-space: pre-wrap;
      word-wrap: break-word;
      opacity: 0;
      animation: slideInMessage 0.3s ease-out forwards;
    }
    
    @keyframes slideInMessage {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .msg.user {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-color: var(--border-medium);
      align-self: flex-end;
      max-width: 85%;
    }
    
    .msg.assistant {
      position: relative;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    }
    
    .msg.assistant::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--accent-blue);
      border-radius: 3px 0 0 3px;
    }
    
    .input {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 2px solid var(--border-light);
      background: var(--bg-quaternary);
    }
    
    .input textarea {
      flex: 1;
      border-radius: 8px;
      border: 2px solid var(--border-light);
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 10px;
      height: 70px;
      resize: none;
      font-family: inherit;
      transition: all var(--transition-fast);
    }
    
    .input textarea:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: var(--shadow-glow);
    }
    
    .input button {
      padding: 10px 16px;
      border-radius: 8px;
      border: 2px solid var(--accent-blue);
      background: var(--accent-blue);
      color: white;
      cursor: pointer;
      font-weight: 500;
      transition: all var(--transition-fast);
      align-self: flex-end;
    }
    
    .input button:hover {
      background: var(--accent-blue-hover);
      transform: translateY(-1px);
    }
    
    .small {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    /* Responsive improvements */
    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      
      header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .send-all {
        min-width: auto;
      }
      
      .small {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <strong>
      <span style="font-size: 20px;">ðŸŽ¯</span>
      Artemis â€¢ Multiâ€‘Model Chat
    </strong>
    <div class="send-all">
      <input id="broadcast" placeholder="Ask all six modelsâ€¦" />
      <button onclick="sendAll()">
        <span>ðŸ“¤</span>
        Send to All
      </button>
      <button onclick="loadAllModels()">
        <span>ðŸ”„</span>
        Refresh Models
      </button>
    </div>
    <div class="small">
      <span>ðŸ”— Server: http://127.0.0.1:3333</span>
      <span id="model-count">6 models</span>
      <span id="rate">rate: -</span>
    </div>
  </header>
  <div class="grid" id="grid"></div>

  <script>
    const SERVER_URL = 'http://127.0.0.1:3333';
    // Default models for the 6 panes
    const DEFAULT_MODELS = [
      { id:'chatgpt5',    name:'GPTâ€‘5 Chat',           model:'openai/gpt-5-chat' },
      { id:'qwen3',       name:'Qwen3â€‘30Bâ€‘A3B',        model:'qwen/qwen3-30b-a3b' },
      { id:'deepseekv3',  name:'DeepSeek V3 Free',     model:'deepseek/deepseek-chat-v3-0324:free' },
      { id:'grokcode',    name:'Grok Code Fast',       model:'x-ai/grok-code-fast-1' },
      { id:'claude4',     name:'Claude Sonnet 4',      model:'anthropic/claude-sonnet-4' },
      { id:'llama4',      name:'Llama 4 Maverick Free',model:'meta-llama/llama-4-maverick:free' }
    ];
    
    // This will be populated with all available models
    let ALL_MODELS = [...DEFAULT_MODELS];
    const MODELS = [...DEFAULT_MODELS];  // Current pane configurations

    // Fetch all available models from the server
    async function loadAllModels() {
      try {
        const resp = await fetch(`${SERVER_URL}/proxy/openrouter/models`);
        const data = await resp.json();
        if (data.models && data.models.length > 0) {
          // Convert to our format and merge with defaults
          const serverModels = data.models.map(m => ({
            id: m.id.replace(/[^a-zA-Z0-9]/g, '_'),
            name: m.name || m.id,
            model: m.id
          }));
          
          // Keep defaults at top, add all others
          const defaultIds = DEFAULT_MODELS.map(m => m.model);
          const additionalModels = serverModels.filter(m => !defaultIds.includes(m.model));
          ALL_MODELS = [...DEFAULT_MODELS, ...additionalModels];
          
          // Update all dropdowns
          updateAllDropdowns();
          console.log(`Loaded ${ALL_MODELS.length} models`);
          // Update model count in header
          document.getElementById('model-count').textContent = `${ALL_MODELS.length} models`;
        }
      } catch (e) {
        console.error('Failed to load models:', e);
      }
    }
    
    function updateAllDropdowns() {
      MODELS.forEach(model => {
        const sel = document.getElementById('sel-' + model.id);
        if (sel) {
          const currentValue = sel.value;
          const options = ALL_MODELS.map(m => 
            `<option value="${m.model}" ${m.model === currentValue ? 'selected' : ''}>${m.name}</option>`
          ).join('');
          sel.innerHTML = options;
        }
      });
    }
    
    function pane(model){
      const el = document.createElement('div');
      el.className = 'pane';
      el.id = 'pane-' + model.id;
      // model selector - use ALL_MODELS if available
      const options = ALL_MODELS.map(m => `<option value="${m.model}" ${m.model===model.model? 'selected':''}>${m.name}</option>`).join('');
      el.innerHTML = `
        <header>
          <h3>${model.name}</h3>
          <span class="small">Model: 
            <select id="sel-${model.id}" onchange="onModelChange('${model.id}')">${options}</select>
          </span>
        </header>
        <div class="log" id="log-${model.id}"></div>
        <div class="input">
          <textarea id="ta-${model.id}" placeholder="Message ${model.name}â€¦"></textarea>
          <button onclick="send('${model.id}')">Send</button>
        </div>
      `;
      return el;
    }

    function addMsg(modelId, role, text){
      const log = document.getElementById('log-' + modelId);
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
      div.textContent = text;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function onModelChange(modelId){
      const pane = MODELS.find(x => x.id === modelId);
      const sel = document.getElementById('sel-' + modelId);
      if (pane && sel) {
        pane.model = sel.value;
      }
    }

    async function send(modelId){
      const m = MODELS.find(x => x.id === modelId);
      const ta = document.getElementById('ta-' + modelId);
      const q = ta.value.trim();
      if(!q) return;
      addMsg(modelId, 'user', q);
      ta.value = '';
      // Create an assistant placeholder to stream into
      const log = document.getElementById('log-' + modelId);
      const holder = document.createElement('div');
      holder.className = 'msg assistant';
      holder.textContent = '';
      log.appendChild(holder);
      log.scrollTop = log.scrollHeight;

      // Try streaming first; fallback to non-stream fetch on failure
      try{
        const resp = await fetch(`${SERVER_URL}/proxy/openrouter/stream`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: m.model, messages: [{ role:'user', content:q }] })
        });
        if (!resp.body || !resp.ok) throw new Error('stream not available');
        const reader = resp.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '';
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const parts = buffer.split('\n');
          buffer = parts.pop() || '';
          for (const line of parts) {
            if (!line.startsWith('data:')) continue;
            const payload = line.slice(5).trim();
            if (payload === '[DONE]') continue;
            try {
              const json = JSON.parse(payload);
              const delta = json?.choices?.[0]?.delta?.content;
              if (delta) {
                holder.textContent += delta;
                log.scrollTop = log.scrollHeight;
              }
              if (json?.meta?.rate) {
                const r = json.meta.rate;
                document.getElementById('rate').textContent = `rate: ${r['x-ratelimit-remaining-requests']||'-'}/${r['x-ratelimit-remaining-tokens']||'-'}`;
              }
            } catch (_) {
              // not JSON; append raw
              if (payload) {
                holder.textContent += payload + '\n';
              }
            }
          }
        }
        return;
      } catch (e) {
        // fallback non-stream
        try{
          const r = await fetch(`${SERVER_URL}/proxy/openrouter`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: m.model, messages: [{ role:'user', content:q }] })
          });
          const data = await r.json();
          holder.textContent = data.text || JSON.stringify(data);
          if (data.rate) {
            const rate = data.rate;
            document.getElementById('rate').textContent = `rate: ${rate['x-ratelimit-remaining-requests']||'-'}/${rate['x-ratelimit-remaining-tokens']||'-'}`;
          }
          log.scrollTop = log.scrollHeight;
        }catch(err){
          holder.textContent = 'Error: ' + err;
        }
      }
    }

    function sendAll(){
      const v = document.getElementById('broadcast').value.trim();
      if(!v) return;
      MODELS.forEach(m => {
        const ta = document.getElementById('ta-' + m.id);
        ta.value = v;
        send(m.id);
      });
    }

    // Initialize UI
    const grid = document.getElementById('grid');
    MODELS.forEach(m => grid.appendChild(pane(m)));
    
    // Load all available models after page loads
    loadAllModels();
  </script>
</body>
</html>
