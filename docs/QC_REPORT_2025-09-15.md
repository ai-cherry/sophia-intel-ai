# Sophia Intel AI — Quality Control Assessment and Recommendations
Date: 2025-09-15  
Repo: ai-cherry/sophia-intel-ai

## Executive Summary
A focused quality control audit was performed on recent partner changes and core subsystems affecting:
- Chat retrieval (UnifiedChatService → Unified RAG)
- Brain training upload/universal ingestion
- Project management blended dashboard (Asana/Linear/Slack/Airtable)
- CI/CD security posture and workflows
- Secrets handling and config hygiene
- API security (auth, CORS, rate limiting)
Key improvements have landed (chat→RAG wiring, universal upload for txt/md/csv, PM overview endpoint). However, a critical secret exposure persists and several security and UX gaps remain. This report details findings, risks, and a prioritized remediation and enhancement plan.

Overall status:
- Product functionality: Improving, core flows present
- Security posture: At risk (leaked GitHub PAT still in repo files; route hardening incomplete)
- CI/CD and governance: Strong coverage present; ensure secrets scanning gates are strictly enforced
- Next-phase scope: Citations and telemetry in chat, robust upload pipeline (dedupe, status, SSE), PM overview auth + SSE, Airtable foundational memory integration

---

## Scope and Method
- Code inspection of recent changes:
  - app/api/services/unified_chat.py
  - app/api/routers/brain_training.py
  - app/api/routers/projects.py
- Repository-wide scans:
  - Secrets (GitHub PAT patterns)
  - CI workflows inventory under .github/workflows
- Targeted checks for SSE endpoints, rate limiting, and CORS/security middleware
- Cross-reference with prior security recommendations

---

## Findings

### 1) Secrets and Configuration Hygiene
- Critical: Exposed GitHub PAT still present in working tree
  - Files:
    - pulumi-esc-dev.yaml
    - pulumi-esc-staging.yaml
    - pulumi-esc-prod.yaml
    - centralized_config.yaml
  - The PAT appears in multiple JSON/YAML blocks (including fn::secret strings). Treat as compromised.
- Claimed example config additions are absent
  - centralized_config.example.yaml
  - pulumi-esc-{dev,staging,prod}.example.yaml
- .gitignore now correctly ignores these YAMLs, preventing future tracking. However, the secrets remain in files and in history.

Risk: Compromise of GitHub org or repos; automated abuse; supply-chain risk.

Action: Immediate revocation of the PAT; add sanitized templates; remove sensitive YAMLs from working tree; plan history purge.

---

### 2) CI/CD and Security Workflows
- Workflows present:
  - security.yml (present), security-scan.yml, verify-webhooks.yml, dependency-check.yml, tests.yml, ci.yml, and additional guard workflows
- verify-webhooks.yml + scripts/verify_webhooks.sh:
  - Performs real Asana handshake echo, Gong HMAC, Slack v0 signature tests against a live BASE_URL with environment secrets. This is good practice.

Gaps:
- Ensure secrets scanning is blocking (gitleaks or equivalent) on PRs across the full tree, not only diffs.
- Confirm bandit/safety/pip-audit/trivy gates are set to fail builds on high/critical issues.

---

### 3) Chat Retrieval (UnifiedChatService → Unified RAG)
File: app/api/services/unified_chat.py

Strengths:
- UnifiedRAGSystem integrated with domain routing (SOPHIA for sales/BI/business; SHARED otherwise).
- Parallel fetch with circuit breakers and timeouts (web/internal/MCP).
- Synthesized RAG context returned; source lists include relevance/confidence in the internal result payload.

Gaps:
- Citations are not surfaced in the top-level chat response (no explicit citations[] with IDs/URIs). The UI cannot show clickable sources.
- Domain routing is heuristic-only (keyword-based). No explicit override via request input; no mapping table for engineering/support/finance.
- Confidence blending uses fixed defaults (0.8) and doesn’t weight by retrieval score distributions or penalize timeouts robustly.
- Missing telemetry and RAG eval hooks (trace_id, retrieval_stats, Phoenix evaluations) for continuous quality monitoring.

---

### 4) Brain Training Universal Upload
File: app/api/routers/brain_training.py

Strengths:
- POST /api/brain-training/upload-universal added:
  - Allows multiple files (txt, md/markdown, csv), size cap (100 MB/file), UTF‑8 decode with replace.
  - Stores content to UnifiedMemoryStore via BackgroundTasks with provenance metadata.
- Gong CSV training preserved with size cap and a rate limiter (HTTPBearer auth applied).

Gaps:
- No MAX_BATCH_FILES enforcement in the universal upload route (constant defined but unused).
- No checksum/dedup to avoid duplicate ingests and bloat.
- CSV formula injection not sanitized (risk if data is later exported to spreadsheets).
- No job_id returned; no /status/{job_id} parity for universal uploads; no SSE progress; limited UX visibility for long-running ingest.
- Optional: No malware scanning for externally sourced uploads.

---

### 5) PM Blended Dashboard (Overview)
File: app/api/routers/projects.py

Strengths:
- GET /api/projects/overview returns normalized DTO with cache (TTL) and ETag; handles partial integration failures and logs notes.
- GET /api/projects/sync-status reports environment-based configurability for Asana/Linear/Slack/Airtable.

Gaps:
- No bearer auth or rate limiting: open data surface to the internet if deployed without upstream auth.
- DTO is minimal: lacks spend/budget, velocity, overdue ratio, OKR alignment scoring; lacks filters (team, period).
- Cache key not parameterized (for future filters); lacks stale-while-revalidate behavior.
- No SSE broadcasting of updates; UI must poll.

---

### 6) SSE/Event Bus and UI Glue
- verify-webhooks, AG-UI stream references exist; agui_stream route is present in the repo.
- Chat streaming and dashboard real-time updates are not wired end-to-end in these examined files (retrieval trace/citations are not streamed as events).

---

### 7) API Security (Auth, CORS, Rate Limiting, Headers)
- HTTPBearer enforced on brain training routes; good.
- Missing consistent auth on chat and PM overview endpoints (needs confirmation on the specific routers registering these paths).
- CORS policy needs to be verified/restricted to dashboard origins.
- Security headers middleware (HSTS, X-Content-Type-Options, X-Frame-Options, Referrer-Policy, Permissions-Policy) not confirmed.
- Rate limiting applied for Gong upload only; should be extended to universal upload, chat, and overview.

---

## Recommendations (Prioritized)

### Priority 0 (Immediate)
1) Revoke exposed GitHub PAT in GitHub and enable Secret Scanning + Push Protection org/repo-wide.
2) Add sanitized templates and remove sensitive files from working tree:
   - Add docs: centralized_config.example.yaml and pulumi-esc-{dev,staging,prod}.example.yaml
   - Ensure .gitignore retains centralized_config.yaml and pulumi-esc-*.yaml ignore rules.
3) Prepare a vetted, separate history purge plan (BFG/filter-repo) to excise the PAT and sensitive YAMLs from Git history; require explicit approval before execution.
4) Ensure security workflows block on critical/high findings; confirm gitleaks scan covers the full tree.

### Priority 1 (Chat and Upload Enhancements)
5) Chat retrieval and UX
   - API additions:
     - Add citations[] to chat response: [{id, title, uri, source_type, relevance, metadata}]
     - Add retrieval_stats and trace_id for telemetry.
   - Domain control:
     - Support explicit context.domain override.
     - Provide a configurable mapping table for heuristics (engineering, finance, support, BI, etc.), fallback to SHARED.
   - Scoring and resilience:
     - Weight confidence by retrieval score distribution; penalize timeouts; graceful fallbacks.
   - Security:
     - Enforce HTTPBearer and per-user/per-IP rate limiting on chat routes.
     - Restrict CORS to trusted dashboard origins.

6) Universal upload robustness
   - Enforce MAX_BATCH_FILES and a total aggregate body size cap.
   - Add checksum (sha256) dedupe; return dedupe counts in response.
   - Sanitize CSV formulas (escape lines starting with =, +, -, @).
   - Return job_id; add GET /api/brain-training/status/{job_id}; emit SSE progress.
   - Optional: Integrate malware scanning for non-trusted uploads (feature-flagged).

### Priority 2 (PM Dashboard and Foundations)
7) Projects overview hardening
   - Add HTTPBearer + rate limiting to /api/projects routes.
   - Expand DTO with spend/budget, velocity, overdue ratio, OKR alignment (computed heuristics), and filters (team, period).
   - Parameterize cache keys; implement stale-while-revalidate; broadcast deltas via SSE to reduce polling.

8) Airtable foundational memory glue
   - On sync, generate semantic summaries per record (employee roster, customers, mission, competitors) and write to Unified Memory with tags (source=airtable).
   - Expose:
     - GET /api/knowledge/foundation/search
     - GET /api/knowledge/foundation/{id} (with redaction)
   - Ensure Chat includes these citations when relevant.

### Priority 3 (Observability, Evals, and Governance)
9) Observability and RAG evals
   - Emit traces (Phoenix) for chat flows; add evaluate_rag jobs for relevance/QA/hallucination.
   - Add alerting for regressions before deploy.

10) Governance and docs
   - Update SECURITY.md and README to reflect secrets policy, how to populate configs via GitHub Environments/Pulumi ESC, and how to run security workflows.
   - Add CONTRIBUTING.md checklist (no secrets, run CI locally if applicable, PR conventions).

---

## Acceptance Criteria (Verification)
- search for github_pat_.* returns 0 in working tree; example templates exist; sensitive YAMLs removed and ignored.
- Security workflows (gitleaks, bandit, safety/pip-audit, trivy) fail builds on high/critical severity.
- Chat responses include citations[] and retrieval_stats; SSE token streaming and retrieval trace events visible; domain override works.
- Universal upload returns job_id; status endpoint reports progress; SSE updates show per-file ingest; dedupe effective and reported.
- Projects overview authenticated, rate-limited; supports filters; SSE deltas; ETag and SWR effective; DTO includes KPIs and alignment.
- Airtable foundational summaries accessible via new endpoints; appear as chat citations; PII redaction enforced.

---

## Quick Validation Steps

Secrets and templates:
```bash
# Secrets scan (repo root)
grep -R --line-number -E 'github_pat_[A-Za-z0-9_]+' .
# Expect: no matches after remediation

# Verify example templates exist
ls centralized_config.example.yaml
ls pulumi-esc-dev.example.yaml pulumi-esc-staging.example.yaml pulumi-esc-prod.example.yaml
```

Chat and RAG:
```bash
# Example chat request (adjust route if different)
curl -X POST https://<BASE>/api/chat \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{ "query": "Strategic initiatives", "context": {"domains": ["bi"], "domain": "SOPHIA"} }'
# Expect: citations[], retrieval_stats, trace_id
```

Universal upload:
```bash
curl -X POST https://<BASE>/api/brain-training/upload-universal \
  -H "Authorization: Bearer <TOKEN>" \
  -F "files=@notes.md" \
  -F "files=@customers.csv" \
  -F "learning_objectives=onboarding,playbooks"
# Expect: { status: "queued", job_id, accepted[], rejected[] (with dedupe info) }

curl https://<BASE>/api/brain-training/status/<job_id> \
  -H "Authorization: Bearer <TOKEN>"
# Expect: progress metrics
```

Projects overview:
```bash
curl -i "https://<BASE>/api/projects/overview?team=core&period=14d" \
  -H "Authorization: Bearer <TOKEN>" \
  -H "If-None-Match: <etag-from-previous-call>"
# Expect: 304 if unchanged; DTO includes KPIs; headers with ETag
```

---

## Appendix: Evidence and Artifacts
- Exposed PAT occurrences observed in:
  - pulumi-esc-dev.yaml, pulumi-esc-staging.yaml, pulumi-esc-prod.yaml, centralized_config.yaml
- Security workflows present:
  - .github/workflows/security.yml, security-scan.yml, verify-webhooks.yml, and related CI configs
- Key endpoint files:
  - Chat: app/api/services/unified_chat.py (UnifiedRAGSystem integration, synthesis)
  - Brain: app/api/routers/brain_training.py (upload-universal, Gong CSV pipeline)
  - PM Overview: app/api/routers/projects.py (overview + sync-status)
  - Webhook validation: .github/workflows/verify-webhooks.yml and scripts/verify_webhooks.sh

---

## Next Steps (What I can implement immediately)
- Create sanitized example configs and remove sensitive YAMLs from the working tree (non-destructive).
- Add citations[] and retrieval telemetry to chat; add explicit domain override and improved scoring.
- Harden upload-universal (batch limits, dedupe, formula guard, job status, SSE).
- Secure and expand PM overview; add SSE deltas.
- Add/confirm CI gates (gitleaks blocking, bandit/safety/pip-audit/trivy).
- Prepare a separate, approved history purge plan for the PAT and sensitive YAMLs.
