# ADR-005: Memory System Integration Architecture

**Status**: Accepted  
**Date**: 2025-01-09  

## Context

Multi-agent swarms require sophisticated memory with fast retrieval, deduplication, and multiple search strategies for different query types.

## Decision

**Three-tier hybrid memory architecture: SQLite FTS5 + Weaviate vectors + Redis caching.**

Core implementation in [`unified_memory.py`](../../../pulumi/mcp-server/src/unified_memory.py):

### Storage Backends
- **SQLite FTS5**: Metadata, full-text search, BM25 scoring
- **Weaviate**: Vector similarity with `sentence-transformers/all-MiniLM-L6-v2`  
- **Redis**: Search result caching with 1-hour TTL

### Deduplication Strategy
```python
# Hash-based deduplication (lines 70-76)
hash_id = hashlib.sha256(f"{topic}:{content}:{source}".encode()).hexdigest()[:16]
```

### Multi-Tier Search Optimization
1. **Cache Check**: Redis lookup for previous results
2. **Vector Search**: Weaviate near-text queries  
3. **FTS Search**: SQLite BM25 text matching
4. **Result Fusion**: Weighted combination (vector 0.7, FTS 0.3)
5. **LLM Reranking**: [`_rerank_results()`](../../../pulumi/mcp-server/src/unified_memory.py:641) with `claude-3-haiku`

## Implementation

**Core Class**: [`UnifiedMemoryStore`](../../../pulumi/mcp-server/src/unified_memory.py:140)  
**Methods**: [`search_memory()`](../../../pulumi/mcp-server/src/unified_memory.py:434), [`add_memory()`](../../../pulumi/mcp-server/src/unified_memory.py:346)  
**Fallbacks**: Each tier fails gracefully if backend unavailable

## Consequences

**Positive**: Fast retrieval, intelligent ranking, duplicate prevention, fault tolerance  
**Negative**: Storage overhead, complexity in result combination  
**Performance**: Sub-100ms cached queries, 500ms uncached with reranking