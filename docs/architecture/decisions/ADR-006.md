# ADR-006: Configuration Management Standardization

**Status**: Accepted  
**Date**: 2025-01-09

## Context

Multi-service architecture requires centralized configuration management with secure secrets handling and environment-specific overrides.

## Decision

**Hierarchical Pulumi ESC + EnvLoader pattern with graceful fallbacks.**

Primary configuration in [`sophia-intel-base.yaml`](../../../pulumi/environments/sophia-intel-base.yaml) loaded via [`EnvLoader`](../../../app/config/env_loader.py:102):

### Configuration Hierarchy

1. **Pulumi ESC**: Primary secrets and shared configuration
2. **Environment Files**: `.env.complete` → `.env.local` → `.env`
3. **Environment Variables**: Direct overrides for containers

### Provider Configuration Pattern

```python
# Portkey gateway with virtual keys for unified access
providers:
  portkey:
    base_url: https://api.portkey.ai/v1
    virtual_keys: {openrouter, anthropic, openai, together, groq}
```

### Fallback Strategy

```python
# env_loader.py:157-187 - ESC first, .env fallback
if self._pulumi_available:
    _env_loader.load_from_pulumi_esc()
else:
    _env_loader.load_from_env_file()
```

## Implementation

**Configuration Class**: [`EnvConfig`](../../../app/config/env_loader.py:15) with 50+ standardized settings  
**Validation**: [`validate_config()`](../../../app/config/env_loader.py:250) checks gateway + provider readiness  
**Loading**: Automatic detection with [`_check_pulumi_esc()`](../../../app/config/env_loader.py:116)

## Consequences

**Positive**: Centralized secrets, environment isolation, graceful degradation  
**Negative**: ESC dependency, configuration complexity  
**Security**: Secrets never in code, ESC encryption at rest, environment separation
