# ADR-008: Deployment and Operations Architecture

**Status**: Accepted  
**Date**: 2025-01-09

## Context

Multi-agent autonomous swarms require reliable production deployment with auto-scaling, health monitoring, and service isolation.

## Decision

**Fly.io microservices architecture with intelligent auto-scaling and internal networking.**

### Service Boundaries

- **sophia-api**: Main orchestrator ([`fly-unified-api.toml`](../../../fly-unified-api.toml)) - 4 CPU, 4GB RAM, min 2 instances
- **sophia-mcp**: Memory/tool server ([`fly-mcp-server.toml`](../../../fly-mcp-server.toml)) - 2 CPU, 2GB RAM, min 1 instance
- **sophia-vector**: Embedding service ([`fly-vector-store.toml`](../../../fly-vector-store.toml)) - 2 CPU, 2GB RAM, min 1 instance

### Local Development

Full stack in [`docker-compose.local.yml`](../../../docker-compose.local.yml):

```yaml
# Core services (lines 12-250)
services:
  [
    weaviate,
    postgres,
    redis,
    unified-api,
    agno-bridge,
    mcp-server,
    vector-store,
    agent-ui,
  ]
```

### Health Checks & Scaling

- **Health Endpoints**: `/healthz` (API), `/health` (MCP/Vector)
- **Auto-scaling**: CPU 60-70%, Memory 70-75%, Response time <200ms
- **Connection Limits**: API 250, MCP 150, Vector 200 concurrent connections
- **Internal Networking**: `*.internal` domains for service-to-service communication

### Persistent Storage

- **API Data**: 15GB mounted volume for orchestrator state
- **MCP Data**: 5GB for memory storage
- **Vector Cache**: 10GB for embedding cache

## Implementation

**Orchestration**: Fly.io with auto-rollback and Consul service discovery  
**Monitoring**: Prometheus metrics on port 9091, health check intervals 15-30s  
**Scaling**: Workload-specific thresholds (API scales at 60% CPU, Vector at 65%)

## Consequences

**Positive**: Geographic distribution, auto-scaling, isolated service failures, persistent storage  
**Negative**: Network latency between services, Fly.io platform dependency  
**Operations**: Zero-downtime deployments, automatic failure recovery, cost-optimized scaling
