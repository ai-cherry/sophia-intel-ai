<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOPHIA Business Intelligence Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Sophia Business Theme - Professional Blue Wisdom */
            --sophia-primary: #4A90E2;
            --sophia-primary-dark: #2171B5;
            --sophia-secondary: #6BAED6;
            --sophia-accent: #9ECAE1;
            --sophia-wisdom: #3182BD;
            --sophia-insight: #08519C;
            
            /* Dark Theme Foundation */
            --bg-primary: #0B0E14;
            --bg-secondary: #151925;
            --bg-tertiary: #1F2937;
            --bg-card: #252B3D;
            --bg-chat: #1A202C;
            --bg-input: #2D3748;
            
            /* Text Colors */
            --text-primary: #FFFFFF;
            --text-secondary: #CBD5E0;
            --text-muted: #718096;
            --text-accent: var(--sophia-primary);
            
            /* Interactive Elements */
            --border-primary: var(--sophia-primary);
            --border-secondary: #374151;
            --shadow-primary: rgba(74, 144, 226, 0.2);
            --shadow-secondary: rgba(0, 0, 0, 0.3);
            --glow-primary: 0 0 20px var(--sophia-primary);
            
            /* Layout */
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(74, 144, 226, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(49, 113, 181, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 90%, rgba(8, 81, 156, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: wisdomFlow 20s ease-in-out infinite;
        }

        @keyframes wisdomFlow {
            0%, 100% { opacity: 0.4; transform: translateY(0px) scale(1); }
            50% { opacity: 0.6; transform: translateY(-20px) scale(1.05); }
        }

        /* Header */
        .header {
            background: rgba(37, 43, 61, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--border-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px var(--shadow-secondary);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--sophia-primary);
            text-shadow: var(--glow-primary);
            animation: logoGlow 3s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--sophia-primary), var(--sophia-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'JetBrains Mono', monospace;
        }

        .logo-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            color: var(--sophia-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--sophia-primary);
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: var(--glow-primary);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.3); }
        }

        .voice-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            color: var(--text-secondary);
            padding: var(--spacing-xs) var(--spacing-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .voice-toggle:hover {
            background: var(--sophia-primary);
            color: var(--text-primary);
            box-shadow: var(--glow-primary);
        }

        .voice-toggle.active {
            background: var(--sophia-primary);
            color: var(--text-primary);
            box-shadow: var(--glow-primary);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 100px);
        }

        /* Chat Section - Primary Focus */
        .chat-section {
            flex: 1;
            padding: var(--spacing-lg);
            max-width: 800px;
        }

        .chat-container {
            background: var(--bg-chat);
            border: 2px solid var(--border-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 32px var(--shadow-primary);
            height: 70vh;
            display: flex;
            flex-direction: column;
            margin-bottom: var(--spacing-lg);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--sophia-primary), var(--sophia-wisdom));
            padding: var(--spacing-md);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .orchestrator-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .chat-controls {
            display: flex;
            gap: var(--spacing-xs);
        }

        .chat-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            padding: var(--spacing-xs);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .chat-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .chat-messages {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .message {
            display: flex;
            gap: var(--spacing-sm);
            align-items: flex-start;
            max-width: 85%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--sophia-secondary), var(--sophia-accent));
            color: var(--text-primary);
        }

        .message.sophia .message-avatar {
            background: linear-gradient(135deg, var(--sophia-primary), var(--sophia-wisdom));
            color: var(--text-primary);
        }

        .message-content {
            background: var(--bg-card);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-secondary);
            flex: 1;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--sophia-primary), var(--sophia-secondary));
            color: var(--text-primary);
            border-color: var(--sophia-primary);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
        }

        .chat-input-area {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-secondary);
            background: var(--bg-card);
        }

        .chat-input-group {
            display: flex;
            gap: var(--spacing-sm);
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 50px;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--border-primary);
            box-shadow: 0 0 0 3px var(--shadow-primary);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--sophia-primary), var(--sophia-wisdom));
            border: none;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-primary);
        }

        /* Widgets Sidebar */
        .widgets-sidebar {
            width: 400px;
            padding: var(--spacing-lg) var(--spacing-md);
            background: rgba(37, 43, 61, 0.5);
            border-left: 1px solid var(--border-secondary);
            overflow-y: auto;
        }

        .widget-section {
            margin-bottom: var(--spacing-xl);
        }

        .widget-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .widget-title i {
            color: var(--sophia-primary);
        }

        .widget-card {
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .widget-card:hover {
            border-color: var(--border-primary);
            box-shadow: 0 4px 20px var(--shadow-primary);
            transform: translateY(-2px);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .metric-icon {
            color: var(--sophia-primary);
            font-size: 1.2rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--sophia-primary);
            margin-bottom: var(--spacing-xs);
            font-family: 'JetBrains Mono', monospace;
        }

        .metric-change {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .metric-change.positive {
            color: #10B981;
        }

        .metric-change.negative {
            color: #EF4444;
        }

        .drill-down-btn {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid var(--sophia-primary);
            border-radius: var(--border-radius);
            color: var(--sophia-primary);
            padding: var(--spacing-xs) var(--spacing-sm);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: var(--spacing-sm);
            width: 100%;
        }

        .drill-down-btn:hover {
            background: var(--sophia-primary);
            color: var(--text-primary);
        }

        /* Business Intelligence Specific Widgets */
        .sales-pipeline-widget {
            border-left: 4px solid #10B981;
        }

        .client-health-widget {
            border-left: 4px solid #F59E0B;
        }

        .research-insights-widget {
            border-left: 4px solid #8B5CF6;
        }

        .bi-dashboard-widget {
            border-left: 4px solid #EC4899;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            margin: var(--spacing-xs) 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--sophia-primary), var(--sophia-secondary));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Sophia Insight Box */
        .sophia-insight {
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(8, 81, 156, 0.1));
            border: 1px solid var(--sophia-primary);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin: var(--spacing-lg) 0;
            position: relative;
        }

        .sophia-insight::before {
            content: '💡';
            position: absolute;
            top: -10px;
            left: 15px;
            background: var(--bg-primary);
            padding: 0 5px;
            font-size: 1.2rem;
        }

        .insight-title {
            color: var(--sophia-primary);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--sophia-primary);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .widgets-sidebar {
                width: 100%;
                border-left: none;
                border-top: 1px solid var(--border-secondary);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .chat-section {
                padding: var(--spacing-sm);
            }
            
            .widgets-sidebar {
                padding: var(--spacing-sm);
            }
        }

        /* Custom Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--sophia-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--sophia-secondary);
        }

    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-brain"></i>
                <div class="logo-text">
                    <div class="logo-title">SOPHIA</div>
                    <div class="logo-subtitle">Business Intelligence</div>
                </div>
            </div>
            <div class="header-controls">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>ORCHESTRATOR ONLINE</span>
                </div>
                <div class="voice-toggle" id="voiceToggle">
                    <i class="fas fa-microphone"></i>
                    <span>Voice Ready</span>
                </div>
                <div class="status-indicator">
                    <i class="fas fa-users"></i>
                    <span>BI Suite Active</span>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Universal Chat Interface - Primary Focus -->
        <section class="chat-section">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-comments"></i>
                        Universal Chat Interface
                        <span class="orchestrator-badge">Sophia Orchestrator</span>
                    </div>
                    <div class="chat-controls">
                        <button class="chat-btn" id="voiceInputBtn" title="Voice Input">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="chat-btn" id="settingsBtn" title="Chat Settings">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="chat-btn" id="clearChatBtn" title="Clear Chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message sophia">
                        <div class="message-avatar">S</div>
                        <div class="message-content">
                            <div class="message-time">Just now</div>
                            <div>Welcome to Sophia Business Intelligence! I'm your strategic AI partner, here to provide deep insights across sales, customer analytics, market research, and business intelligence. I have access to your complete business data ecosystem and can orchestrate complex analyses across multiple AI agents. What business challenge shall we tackle today?</div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="chat-input-group">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="Ask me anything about your business... sales performance, market trends, customer insights, strategic analysis..."
                            rows="2"
                        ></textarea>
                        <button id="sendBtn" class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <div class="sophia-insight">
                <div class="insight-title">Sophia's Strategic Insight</div>
                <div>Your Q3 performance metrics show a 23% improvement in deal velocity. The correlation between Gong call scores and close rates suggests we should scale our best discovery techniques across the entire sales team. I'm monitoring 47 active opportunities and can provide real-time competitive intelligence on any prospect.</div>
            </div>
        </section>

        <!-- Business Intelligence Widgets Sidebar -->
        <aside class="widgets-sidebar">
            <div class="widget-section">
                <div class="widget-title">
                    <i class="fas fa-chart-line"></i>
                    Sales Metrics
                </div>

                <div class="widget-card sales-pipeline-widget" onclick="drillDownSales()">
                    <div class="metric-header">
                        <div class="metric-label">Pipeline Value</div>
                        <i class="fas fa-funnel-dollar metric-icon"></i>
                    </div>
                    <div class="metric-value">$2.4M</div>
                    <div class="metric-change positive">+18% this quarter</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 73%;"></div>
                    </div>
                    <button class="drill-down-btn">View Pipeline Details</button>
                </div>

                <div class="widget-card sales-pipeline-widget" onclick="drillDownWinRate()">
                    <div class="metric-header">
                        <div class="metric-label">Win Rate</div>
                        <i class="fas fa-trophy metric-icon"></i>
                    </div>
                    <div class="metric-value">73%</div>
                    <div class="metric-change positive">+5% improvement</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 73%;"></div>
                    </div>
                    <button class="drill-down-btn">Analyze Win/Loss Factors</button>
                </div>
            </div>

            <div class="widget-section">
                <div class="widget-title">
                    <i class="fas fa-phone"></i>
                    Gong Intelligence
                </div>

                <div class="widget-card client-health-widget" onclick="drillDownGongCalls()">
                    <div class="metric-header">
                        <div class="metric-label">Calls Analyzed Today</div>
                        <i class="fas fa-phone-alt metric-icon"></i>
                    </div>
                    <div class="metric-value">47</div>
                    <div class="metric-change positive">Avg Score: 89%</div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
                            Top Keywords: Budget (23), Timeline (18), Decision (15)
                        </div>
                    </div>
                    <button class="drill-down-btn">View Call Analytics</button>
                </div>

                <div class="widget-card client-health-widget" onclick="drillDownSentiment()">
                    <div class="metric-header">
                        <div class="metric-label">Customer Sentiment</div>
                        <i class="fas fa-heart metric-icon"></i>
                    </div>
                    <div class="metric-value">+87%</div>
                    <div class="metric-change positive">Highly positive trend</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
                        🟢 Positive: 67% | 🟡 Neutral: 20% | 🔴 Negative: 13%
                    </div>
                    <button class="drill-down-btn">Sentiment Deep Dive</button>
                </div>
            </div>

            <div class="widget-section">
                <div class="widget-title">
                    <i class="fas fa-lightbulb"></i>
                    Research Insights
                </div>

                <div class="widget-card research-insights-widget" onclick="drillDownMarketIntel()">
                    <div class="metric-header">
                        <div class="metric-label">Market Intelligence</div>
                        <i class="fas fa-globe metric-icon"></i>
                    </div>
                    <div class="metric-value">12</div>
                    <div class="metric-change positive">New insights this week</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
                        🔥 Trending: AI adoption in healthcare, fintech consolidation
                    </div>
                    <button class="drill-down-btn">Explore Market Trends</button>
                </div>

                <div class="widget-card research-insights-widget" onclick="drillDownCompetitive()">
                    <div class="metric-header">
                        <div class="metric-label">Competitive Analysis</div>
                        <i class="fas fa-chess metric-icon"></i>
                    </div>
                    <div class="metric-value">94%</div>
                    <div class="metric-change positive">Intelligence coverage</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
                        Monitoring 23 competitors, 8 new product launches detected
                    </div>
                    <button class="drill-down-btn">View Competitor Intel</button>
                </div>
            </div>

            <div class="widget-section">
                <div class="widget-title">
                    <i class="fas fa-chart-pie"></i>
                    BI Dashboard
                </div>

                <div class="widget-card bi-dashboard-widget" onclick="drillDownCustomerHealth()">
                    <div class="metric-header">
                        <div class="metric-label">Client Health Score</div>
                        <i class="fas fa-heartbeat metric-icon"></i>
                    </div>
                    <div class="metric-value">8.7/10</div>
                    <div class="metric-change positive">+0.3 this month</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
                        🟢 Healthy: 73% | 🟡 At Risk: 19% | 🔴 Critical: 8%
                    </div>
                    <button class="drill-down-btn">Client Health Analysis</button>
                </div>

                <div class="widget-card bi-dashboard-widget" onclick="drillDownRevenueForecast()">
                    <div class="metric-header">
                        <div class="metric-label">Revenue Forecast</div>
                        <i class="fas fa-chart-area metric-icon"></i>
                    </div>
                    <div class="metric-value">$8.2M</div>
                    <div class="metric-change positive">Q4 projection +12%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 67%;"></div>
                    </div>
                    <button class="drill-down-btn">View Revenue Model</button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        class SophiaBusinessIntelligence {
            constructor() {
                this.websocket = null;
                this.voiceEnabled = false;
                this.recognition = null;
                this.speechSynthesis = null;
                this.isListening = false;
                this.drillDownMode = false;
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initializeVoice();
                this.connectWebSocket();
                this.startRealTimeUpdates();
                this.loadWelcomeMessage();
                console.log('🧠 Sophia Business Intelligence Platform initialized');
            }

            setupEventListeners() {
                // Chat functionality
                document.getElementById('sendBtn').addEventListener('click', () => {
                    this.sendMessage();
                });

                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Voice controls
                document.getElementById('voiceToggle').addEventListener('click', () => {
                    this.toggleVoice();
                });

                document.getElementById('voiceInputBtn').addEventListener('click', () => {
                    this.startVoiceInput();
                });

                // Chat controls
                document.getElementById('clearChatBtn').addEventListener('click', () => {
                    this.clearChat();
                });
            }

            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                // Add user message
                this.addMessage('user', message);
                input.value = '';

                // Show typing indicator
                const typingId = this.addMessage('sophia', '<span class="loading"></span> Analyzing with strategic intelligence...', true);

                try {
                    // Simulate Sophia's intelligent response
                    const response = await this.generateSophiaResponse(message);
                    
                    // Remove typing indicator and add response
                    this.removeMessage(typingId);
                    this.addMessage('sophia', response);
                    
                    if (this.voiceEnabled) {
                        this.speak(response);
                    }
                } catch (error) {
                    this.removeMessage(typingId);
                    this.addMessage('sophia', "I encountered an issue processing your request. Let me refocus and try a different approach to your business intelligence query.");
                }
            }

            async generateSophiaResponse(message) {
                // Simulate API call to Sophia orchestrator
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
                
                // Intelligent response generation based on message content
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('sales') || lowerMessage.includes('pipeline')) {
                    return `Based on your current pipeline analysis, I see $2.4M in active opportunities with a 73% win rate. Your Q3 performance shows strong momentum in enterprise deals, particularly in the healthcare and fintech verticals. The correlation between Gong call scores and close rates suggests your discovery methodology is highly effective. Would you like me to deep-dive into the specific accounts that are most likely to close this quarter?`;
                }
                
                if (lowerMessage.includes('customer') || lowerMessage.includes('client')) {
                    return `Your client health metrics are strong at 8.7/10 average score. I'm tracking engagement patterns across 47 accounts and notice that clients with regular quarterly business reviews have 34% higher retention rates. Three accounts currently require immediate attention due to declining usage metrics. Shall I prioritize these for your customer success team and draft strategic retention plans?`;
                }
                
                if (lowerMessage.includes('market') || lowerMessage.includes('competitive')) {
                    return `My market intelligence analysis reveals significant opportunities in the AI-driven healthcare space, with 23% projected growth. I'm monitoring 23 competitors and recently identified 8 new product launches that could impact your positioning. The competitive landscape shows consolidation trends that create partnership opportunities. Would you like me to generate a strategic market entry plan for the emerging segments I've identified?`;
                }
                
                if (lowerMessage.includes('gong') || lowerMessage.includes('calls')) {
                    return `Today's Gong analysis of 47 calls shows an average score of 89% with strong discovery patterns. Key conversation themes include budget discussions (23 mentions), timeline concerns (18 mentions), and decision-making processes (15 mentions). I've identified 3 calls with exceptional techniques that should be scaled across your team. The sentiment analysis reveals highly positive customer engagement. Shall I prepare a coaching playbook based on your top-performing calls?`;
                }
                
                if (lowerMessage.includes('revenue') || lowerMessage.includes('forecast')) {
                    return `Revenue forecasting models project $8.2M for Q4, representing 12% growth over Q3. This forecast incorporates pipeline velocity, seasonal patterns, and competitive factors. The model shows 87% confidence in achieving $7.5M minimum, with upside potential driven by 3 enterprise deals currently in final negotiations. I recommend adjusting territory assignments to capture the additional $700K opportunity I've identified. Would you like me to model different scenarios and resource allocation strategies?`;
                }
                
                // Default strategic response
                return `I've processed your query through multiple analytical frameworks. Based on your business context and current performance metrics, I recommend we approach this strategically. Your data suggests several optimization opportunities across sales velocity, customer engagement, and market positioning. Let me orchestrate a comprehensive analysis across our AI agent network to provide you with actionable insights. What specific business outcome are you prioritizing right now?`;
            }

            addMessage(sender, content, isTemporary = false) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                const messageId = Date.now() + Math.random();
                messageDiv.id = `message-${messageId}`;
                messageDiv.className = `message ${sender}`;
                
                const time = new Date().toLocaleTimeString();
                const avatar = sender === 'user' ? 'U' : 'S';
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        <div class="message-time">${time}</div>
                        <div>${content}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                return isTemporary ? messageId : null;
            }

            removeMessage(messageId) {
                if (messageId) {
                    const element = document.getElementById(`message-${messageId}`);
                    if (element) {
                        element.remove();
                    }
                }
            }

            clearChat() {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                this.loadWelcomeMessage();
            }

            loadWelcomeMessage() {
                setTimeout(() => {
                    this.addMessage('sophia', 'Welcome back to Sophia Business Intelligence! I have full access to your business ecosystem including Gong recordings, pipeline data, customer analytics, and market intelligence. I\'m ready to provide strategic insights and orchestrate complex analyses. How can I drive your business forward today?');
                }, 500);
            }

            initializeVoice() {
                if ('speechSynthesis' in window) {
                    this.speechSynthesis = window.speechSynthesis;
                }

                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('chatInput').value = transcript;
                        this.sendMessage();
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.stopVoiceInput();
                    };

                    this.recognition.onend = () => {
                        this.stopVoiceInput();
                    };
                }
            }

            toggleVoice() {
                this.voiceEnabled = !this.voiceEnabled;
                const toggle = document.getElementById('voiceToggle');
                if (this.voiceEnabled) {
                    toggle.classList.add('active');
                    toggle.innerHTML = '<i class="fas fa-microphone"></i><span>Voice Active</span>';
                } else {
                    toggle.classList.remove('active');
                    toggle.innerHTML = '<i class="fas fa-microphone"></i><span>Voice Ready</span>';
                }
            }

            startVoiceInput() {
                if (this.recognition && !this.isListening) {
                    this.recognition.start();
                    this.isListening = true;
                    document.getElementById('voiceInputBtn').innerHTML = '<i class="fas fa-stop"></i>';
                }
            }

            stopVoiceInput() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                    this.isListening = false;
                    document.getElementById('voiceInputBtn').innerHTML = '<i class="fas fa-microphone"></i>';
                }
            }

            speak(text) {
                if (this.speechSynthesis && this.voiceEnabled) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    
                    // Find a professional female voice
                    const voices = this.speechSynthesis.getVoices();
                    const preferredVoice = voices.find(voice => 
                        voice.name.includes('Female') || 
                        voice.name.includes('Samantha')
                    );
                    if (preferredVoice) {
                        utterance.voice = preferredVoice;
                    }
                    
                    this.speechSynthesis.speak(utterance);
                }
            }

            connectWebSocket() {
                try {
                    this.websocket = new WebSocket('ws://localhost:9000/ws');
                    
                    this.websocket.onopen = () => {
                        console.log('🔗 WebSocket connected to Sophia orchestrator');
                    };

                    this.websocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    };

                    this.websocket.onclose = () => {
                        console.log('🔌 WebSocket disconnected. Attempting reconnection...');
                        setTimeout(() => this.connectWebSocket(), 5000);
                    };
                } catch (error) {
                    console.error('WebSocket connection failed:', error);
                }
            }

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'metric_update':
                        this.updateMetrics(data.metrics);
                        break;
                    case 'chat_response':
                        this.addMessage('sophia', data.message);
                        break;
                    case 'business_insight':
                        this.showBusinessInsight(data.insight);
                        break;
                    default:
                        console.log('Unknown message type:', data.type);
                }
            }

            updateMetrics(metrics) {
                // Update real-time metrics in widgets
                Object.entries(metrics).forEach(([key, value]) => {
                    const element = document.querySelector(`[data-metric="${key}"]`);
                    if (element) {
                        element.textContent = value;
                    }
                });
            }

            startRealTimeUpdates() {
                // Simulate real-time metric updates
                setInterval(() => {
                    this.simulateMetricUpdates();
                }, 30000); // Update every 30 seconds
            }

            simulateMetricUpdates() {
                // Simulate realistic business metric changes
                const metrics = document.querySelectorAll('.metric-value');
                metrics.forEach(metric => {
                    // Add subtle animation to show data is live
                    metric.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        metric.style.transform = 'scale(1)';
                    }, 200);
                });
            }

            showBusinessInsight(insight) {
                const insightBox = document.querySelector('.sophia-insight div:last-child');
                if (insightBox) {
                    insightBox.textContent = insight;
                    insightBox.parentElement.style.animation = 'none';
                    setTimeout(() => {
                        insightBox.parentElement.style.animation = 'wisdomFlow 3s ease-in-out';
                    }, 10);
                }
            }
        }

        // Drill-down functions for widgets
        function drillDownSales() {
            window.sophia.addMessage('sophia', '📊 **Pipeline Deep Dive**: Your $2.4M pipeline breaks down as follows: Enterprise (67% - $1.6M), Mid-Market (23% - $552K), SMB (10% - $240K). Top 5 deals by value are: GlobalTech ($450K, 85% prob), InnovaCorp ($380K, 70% prob), TechStart ($290K, 60% prob), DataFlow ($220K, 80% prob), CloudSys ($180K, 75% prob). Velocity has improved 23% with average deal cycle now 47 days. Would you like me to analyze specific bottlenecks or create action plans for the top opportunities?');
        }

        function drillDownWinRate() {
            window.sophia.addMessage('sophia', '🏆 **Win Rate Analysis**: Your 73% win rate outperforms industry average by 18%. Key success factors: Strong discovery calls (92% correlation with wins), technical demos with 3+ stakeholders (84% win rate), and proposals submitted within 5 days of request (79% win rate). Loss analysis shows pricing concerns (34%), feature gaps (28%), and timing issues (23%) as primary factors. I recommend: 1) Scale discovery framework across team 2) Accelerate demo scheduling 3) Implement competitive pricing strategy. Shall I create detailed action plans for each recommendation?');
        }

        function drillDownGongCalls() {
            window.sophia.addMessage('sophia', '📞 **Gong Analytics Deep Dive**: Today\'s 47 calls show exceptional quality with 89% avg score. Top performers: Sarah Johnson (96% avg, 8 calls), Mike Chen (94% avg, 6 calls), Lisa Rodriguez (92% avg, 5 calls). Best practices identified: Questions in first 3 minutes (correlation with 94% scores), pain point discovery average 12 minutes per call, next steps confirmed in 89% of high-scoring calls. Coaching opportunities: 3 reps need discovery training, 2 need closing technique work. I can generate personalized coaching plans and schedule follow-up sessions. Ready to proceed?');
        }

        function drillDownSentiment() {
            window.sophia.addMessage('sophia', '💭 **Customer Sentiment Analysis**: 87% positive sentiment represents a 12% improvement over last quarter. Sentiment drivers: Product reliability (94% positive mentions), support response time (89% positive), and feature requests being addressed (76% positive). Areas of concern: Pricing transparency (23% negative mentions), onboarding complexity (18% negative). Positive sentiment correlates with 34% higher expansion revenue and 67% higher NPS scores. I recommend: 1) Pricing communication strategy 2) Simplified onboarding process 3) Proactive outreach to negative sentiment accounts. Shall I prioritize these initiatives and create implementation timelines?');
        }

        function drillDownMarketIntel() {
            window.sophia.addMessage('sophia', '🌍 **Market Intelligence Report**: 12 new insights this week reveal significant opportunities. Key trends: AI adoption in healthcare accelerating (34% YoY growth), fintech consolidation creating partnership opportunities (23 M&A deals), and remote work tools market expanding (45% growth). Competitive analysis shows: 3 competitors launching similar features (threat level: medium), 2 strategic partnerships available (opportunity level: high), and 1 market gap in mid-market healthcare AI (opportunity level: very high). Market entry cost estimated at $2.3M with 18-month ROI. Shall I develop a strategic market entry plan with resource requirements and timeline?');
        }

        function drillDownCompetitive() {
            window.sophia.addMessage('sophia', '♟️ **Competitive Intelligence Update**: Monitoring 23 competitors across 5 categories. Recent developments: CompetitorA launched AI analytics feature (impacts 34% of our deals), CompetitorB raised $50M Series C (expansion threat), CompetitorC acquired by enterprise player (market consolidation signal). Our competitive position: Superior in AI/ML capabilities (89% win rate against), weaker in enterprise security features (67% win rate), equal in pricing for mid-market (73% win rate). Recommended actions: 1) Accelerate security roadmap 2) Adjust pricing strategy for enterprise 3) Leverage AI superiority in messaging. Shall I create battle cards and competitive positioning materials?');
        }

        function drillDownCustomerHealth() {
            window.sophia.addMessage('sophia', '💚 **Client Health Deep Analysis**: 8.7/10 average health score with strong upward trend (+0.3 this month). Health factors: Usage frequency (weight: 30%, avg score: 8.9), Support ticket volume (weight: 25%, avg score: 8.4), Feature adoption (weight: 20%, avg score: 8.6), Executive engagement (weight: 15%, avg score: 8.8), Payment history (weight: 10%, avg score: 9.1). At-risk accounts (19%): TechCorp (declining usage), DataSys (support escalations), CloudFlow (low feature adoption). Action plan: Schedule executive reviews with at-risk accounts, implement usage optimization programs, enhance onboarding for new features. Expected impact: +0.5 health score improvement, 12% reduction in churn risk. Proceed with implementations?');
        }

        function drillDownRevenueForecast() {
            window.sophia.addMessage('sophia', '📈 **Revenue Forecast Deep Dive**: Q4 projection of $8.2M represents 12% growth with 89% confidence interval of $7.6M-$8.8M. Model incorporates: Pipeline velocity (47-day avg cycle), seasonal patterns (Q4 typically +15%), competitive factors (3 major launches impact), and economic indicators (business software spending +8%). Upside scenarios ($9.1M possible): Enterprise deals closing early (3 identified), expansion revenue acceleration (+23% YoY), and new market entry success. Downside risks: Economic uncertainty (-5% impact), competitive pressure (-8% impact), team capacity constraints (-3% impact). Recommendation: Secure $7.8M baseline with focused effort on $1.3M upside opportunity. Shall I create detailed quarter execution plan?');
        }

        // Initialize Sophia Business Intelligence
        document.addEventListener('DOMContentLoaded', () => {
            window.sophia = new SophiaBusinessIntelligence();
        });

    </script>
</body>
</html>