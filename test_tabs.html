<!DOCTYPE html>
<html>
<head>
    <title>Tab Switching Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-result {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üîç Hub Tab Switching Test</h1>
    
    <div class="test-result">
        <h2>Test Controls</h2>
        <button onclick="testJavaScriptLoad()">1. Test JavaScript Loading</button>
        <button onclick="testHubController()">2. Test HubController</button>
        <button onclick="testTabManager()">3. Test TabManager</button>
        <button onclick="testTabSwitching()">4. Test Tab Switching</button>
        <button onclick="runAllTests()">Run All Tests</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        const resultsDiv = document.getElementById('results');
        
        function addResult(title, status, details) {
            const div = document.createElement('div');
            div.className = 'test-result';
            div.innerHTML = `
                <h3>${title}</h3>
                <p class="${status}">${status.toUpperCase()}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            resultsDiv.appendChild(div);
        }
        
        function clearResults() {
            resultsDiv.innerHTML = '';
        }
        
        async function testJavaScriptLoad() {
            clearResults();
            addResult('Testing JavaScript File Loading', 'info', 'Attempting to load hub-controller.js...');
            
            try {
                const response = await fetch('http://localhost:8005/static/js/hub-controller.js');
                if (response.ok) {
                    const text = await response.text();
                    const fileSize = (text.length / 1024).toFixed(2);
                    
                    // Check for key classes
                    const hasHubController = text.includes('class HubController');
                    const hasTabManager = text.includes('class TabManager');
                    const hasServiceMonitor = text.includes('class ServiceMonitor');
                    
                    const details = `File Size: ${fileSize} KB
HubController class: ${hasHubController ? '‚úÖ' : '‚ùå'}
TabManager class: ${hasTabManager ? '‚úÖ' : '‚ùå'}
ServiceMonitor class: ${hasServiceMonitor ? '‚úÖ' : '‚ùå'}`;
                    
                    addResult('JavaScript File Load Test', 'success', details);
                } else {
                    addResult('JavaScript File Load Test', 'error', `HTTP ${response.status}`);
                }
            } catch (error) {
                addResult('JavaScript File Load Test', 'error', error.message);
            }
        }
        
        async function testHubController() {
            clearResults();
            
            // Load the script dynamically
            const script = document.createElement('script');
            script.src = 'http://localhost:8005/static/js/hub-controller.js';
            
            script.onload = () => {
                setTimeout(() => {
                    if (window.HubController) {
                        const details = `HubController: ‚úÖ Loaded
ServiceMonitor: ${window.ServiceMonitor ? '‚úÖ' : '‚ùå'}
TabManager: ${window.TabManager ? '‚úÖ' : '‚ùå'}
WSToolsManager: ${window.WSToolsManager ? '‚úÖ' : '‚ùå'}`;
                        
                        addResult('HubController Class Test', 'success', details);
                        
                        // Try to create an instance
                        try {
                            const controller = new window.HubController();
                            addResult('HubController Instance Test', 'success', 
                                `Instance created successfully
Has serviceMonitor: ${controller.serviceMonitor ? '‚úÖ' : '‚ùå'}
Has tabManager: ${controller.tabManager ? '‚úÖ' : '‚ùå'}
Has notifications: ${controller.notifications ? '‚úÖ' : '‚ùå'}`);
                        } catch (error) {
                            addResult('HubController Instance Test', 'error', error.message);
                        }
                    } else {
                        addResult('HubController Class Test', 'error', 'HubController class not found');
                    }
                }, 500);
            };
            
            script.onerror = () => {
                addResult('Script Load Test', 'error', 'Failed to load hub-controller.js');
            };
            
            document.head.appendChild(script);
        }
        
        async function testTabManager() {
            clearResults();
            
            // First ensure the script is loaded
            if (!window.TabManager) {
                await testHubController();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            if (window.TabManager) {
                try {
                    // Create a mock DOM structure
                    const mockHTML = `
                        <div id="test-container">
                            <button data-tab="overview" aria-selected="false">Overview</button>
                            <button data-tab="chat" aria-selected="false">Chat</button>
                            <div id="tab-panel-overview" aria-hidden="true">Overview Panel</div>
                            <div id="tab-panel-chat" aria-hidden="true">Chat Panel</div>
                        </div>
                    `;
                    
                    const container = document.createElement('div');
                    container.innerHTML = mockHTML;
                    document.body.appendChild(container);
                    
                    const tabManager = new window.TabManager();
                    tabManager.init();
                    
                    const details = `TabManager instance created
Current tab: ${tabManager.currentTab}
Tabs cached: ${Object.keys(tabManager.tabs).length}
Panels cached: ${Object.keys(tabManager.panels).length}`;
                    
                    addResult('TabManager Test', 'success', details);
                    
                    // Test switching
                    tabManager.switchTab('chat');
                    const switched = tabManager.currentTab === 'chat';
                    addResult('Tab Switch Test', switched ? 'success' : 'error', 
                        `Switched to chat tab: ${switched ? '‚úÖ' : '‚ùå'}
Current tab after switch: ${tabManager.currentTab}`);
                    
                    // Clean up
                    document.body.removeChild(container);
                    
                } catch (error) {
                    addResult('TabManager Test', 'error', error.message);
                }
            } else {
                addResult('TabManager Test', 'error', 'TabManager class not available');
            }
        }
        
        async function testTabSwitching() {
            clearResults();
            addResult('Hub Tab Switching Test', 'info', 'Opening hub in iframe to test tab switching...');
            
            const iframe = document.createElement('iframe');
            iframe.src = 'http://localhost:8005/hub/';
            iframe.width = '100%';
            iframe.height = '600';
            iframe.style.border = '2px solid #007bff';
            iframe.style.borderRadius = '5px';
            
            iframe.onload = () => {
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const iframeWin = iframe.contentWindow;
                        
                        // Check if hubController exists
                        const hasController = iframeWin.hubController ? true : false;
                        
                        // Find tabs
                        const tabs = iframeDoc.querySelectorAll('[data-tab]');
                        const panels = iframeDoc.querySelectorAll('[id^="tab-panel-"]');
                        
                        let details = `Hub Controller: ${hasController ? '‚úÖ' : '‚ùå'}
Tabs found: ${tabs.length}
Panels found: ${panels.length}`;
                        
                        if (hasController && iframeWin.hubController.tabManager) {
                            const tabManager = iframeWin.hubController.tabManager;
                            details += `\nCurrent tab: ${tabManager.currentTab}`;
                            
                            // Try to switch tabs
                            const initialTab = tabManager.currentTab;
                            tabManager.switchTab('chat');
                            const afterSwitch = tabManager.currentTab;
                            
                            details += `\nTab switch test: ${initialTab} ‚Üí ${afterSwitch}`;
                            details += `\nSwitch successful: ${afterSwitch === 'chat' ? '‚úÖ' : '‚ùå'}`;
                        }
                        
                        addResult('Hub Tab System Test', 'success', details);
                        
                        // Test clicking a tab button
                        if (tabs.length > 1) {
                            const chatTab = Array.from(tabs).find(t => t.getAttribute('data-tab') === 'chat');
                            if (chatTab) {
                                chatTab.click();
                                setTimeout(() => {
                                    const activePanel = iframeDoc.querySelector('.tab-panel.active');
                                    const activePanelId = activePanel ? activePanel.id : 'none';
                                    addResult('Tab Click Test', 'success', 
                                        `Clicked chat tab
Active panel: ${activePanelId}
Chat panel active: ${activePanelId === 'tab-panel-chat' ? '‚úÖ' : '‚ùå'}`);
                                }, 500);
                            }
                        }
                        
                    } catch (error) {
                        addResult('Hub Tab System Test', 'error', `Error accessing iframe: ${error.message}`);
                    }
                }, 1000);
            };
            
            resultsDiv.appendChild(iframe);
        }
        
        async function runAllTests() {
            clearResults();
            addResult('Running All Tests', 'info', 'Starting comprehensive test suite...');
            
            await testJavaScriptLoad();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testHubController();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testTabManager();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testTabSwitching();
            
            addResult('Test Suite Complete', 'success', 'All tests have been executed. Check results above.');
        }
    </script>
</body>
</html>